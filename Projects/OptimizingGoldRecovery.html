<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Umberto Fasci">

<title>Zyfra - Optimizing Gold Recovery</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="OptimizingGoldRecovery_files/libs/clipboard/clipboard.min.js"></script>
<script src="OptimizingGoldRecovery_files/libs/quarto-html/quarto.js"></script>
<script src="OptimizingGoldRecovery_files/libs/quarto-html/popper.min.js"></script>
<script src="OptimizingGoldRecovery_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="OptimizingGoldRecovery_files/libs/quarto-html/anchor.min.js"></script>
<link href="OptimizingGoldRecovery_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="OptimizingGoldRecovery_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="OptimizingGoldRecovery_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="OptimizingGoldRecovery_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="OptimizingGoldRecovery_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#recovery-calculation-function" id="toc-recovery-calculation-function" class="nav-link" data-scroll-target="#recovery-calculation-function">Recovery Calculation Function</a></li>
  <li><a href="#missing-data-imputation" id="toc-missing-data-imputation" class="nav-link" data-scroll-target="#missing-data-imputation">Missing Data Imputation</a>
  <ul class="collapse">
  <li><a href="#experiment" id="toc-experiment" class="nav-link" data-scroll-target="#experiment">Experiment</a></li>
  <li><a href="#application" id="toc-application" class="nav-link" data-scroll-target="#application">Application</a>
  <ul class="collapse">
  <li><a href="#fill-training-data" id="toc-fill-training-data" class="nav-link" data-scroll-target="#fill-training-data">Fill Training Data</a></li>
  <li><a href="#fill-testing-data" id="toc-fill-testing-data" class="nav-link" data-scroll-target="#fill-testing-data">Fill Testing Data</a></li>
  <li><a href="#forward-only-advanced-fill-bfill-induced-data-leakage-sanity-check" id="toc-forward-only-advanced-fill-bfill-induced-data-leakage-sanity-check" class="nav-link" data-scroll-target="#forward-only-advanced-fill-bfill-induced-data-leakage-sanity-check">Forward Only Advanced Fill (<code>bfill</code> induced data leakage sanity check)</a></li>
  <li><a href="#filled-data-inspection" id="toc-filled-data-inspection" class="nav-link" data-scroll-target="#filled-data-inspection">Filled Data Inspection</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#data-fill-experiment-baseline-vs-ffillbfill-vs-forward-fill" id="toc-data-fill-experiment-baseline-vs-ffillbfill-vs-forward-fill" class="nav-link" data-scroll-target="#data-fill-experiment-baseline-vs-ffillbfill-vs-forward-fill">Data Fill Experiment (baseline vs ffill+bfill vs forward fill)</a>
  <ul class="collapse">
  <li><a href="#fill-experiment-including-bfill" id="toc-fill-experiment-including-bfill" class="nav-link" data-scroll-target="#fill-experiment-including-bfill">Fill Experiment Including <code>bfill()</code></a></li>
  <li><a href="#fill-experiment-excluding-bfill" id="toc-fill-experiment-excluding-bfill" class="nav-link" data-scroll-target="#fill-experiment-excluding-bfill">Fill Experiment Excluding <code>bfill()</code></a></li>
  <li><a href="#fill-experiment-forward-fill-method" id="toc-fill-experiment-forward-fill-method" class="nav-link" data-scroll-target="#fill-experiment-forward-fill-method">Fill Experiment (Forward Fill Method)</a></li>
  </ul></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a>
  <ul class="collapse">
  <li><a href="#metal-concentration" id="toc-metal-concentration" class="nav-link" data-scroll-target="#metal-concentration">Metal Concentration</a></li>
  <li><a href="#particle-size-distribution" id="toc-particle-size-distribution" class="nav-link" data-scroll-target="#particle-size-distribution">Particle Size Distribution</a></li>
  <li><a href="#total-concentrations" id="toc-total-concentrations" class="nav-link" data-scroll-target="#total-concentrations">Total Concentrations</a></li>
  </ul></li>
  <li><a href="#preprocessing-and-other-helper-functions" id="toc-preprocessing-and-other-helper-functions" class="nav-link" data-scroll-target="#preprocessing-and-other-helper-functions">Preprocessing and Other Helper Functions</a>
  <ul class="collapse">
  <li><a href="#feature-preparation" id="toc-feature-preparation" class="nav-link" data-scroll-target="#feature-preparation">Feature Preparation</a></li>
  <li><a href="#smape-calculator" id="toc-smape-calculator" class="nav-link" data-scroll-target="#smape-calculator">sMAPE Calculator</a></li>
  <li><a href="#final-smape-calculator" id="toc-final-smape-calculator" class="nav-link" data-scroll-target="#final-smape-calculator">Final sMAPE Calculator</a></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation" class="nav-link" data-scroll-target="#model-evaluation">Model Evaluation</a>
  <ul class="collapse">
  <li><a href="#model-evaluation-function" id="toc-model-evaluation-function" class="nav-link" data-scroll-target="#model-evaluation-function">Model Evaluation Function</a></li>
  <li><a href="#cross-validation-implimentation" id="toc-cross-validation-implimentation" class="nav-link" data-scroll-target="#cross-validation-implimentation">Cross Validation Implimentation</a></li>
  <li><a href="#random-forest-optimization" id="toc-random-forest-optimization" class="nav-link" data-scroll-target="#random-forest-optimization">Random Forest Optimization</a></li>
  <li><a href="#modeling-helper-function" id="toc-modeling-helper-function" class="nav-link" data-scroll-target="#modeling-helper-function">Modeling Helper Function</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#modeling-procedure" id="toc-modeling-procedure" class="nav-link" data-scroll-target="#modeling-procedure">Modeling Procedure</a>
  <ul class="collapse">
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data Preparation</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
<div class="quarto-other-links"><h2>Other Links</h2><ul><li><a href="https://umbertofasci.github.io/"><i class="bi bi-link-45deg"></i>Umberto Fasci Portfolio</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Zyfra - Optimizing Gold Recovery</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Umberto Fasci </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In the mining industry, extracting gold from ore is a complex process that requires multiple stages of purification and refinement. The efficiency of this process, measured by the recovery rate, is crucial for both economic and environmental reasons. This project focuses on developing a machine learning model to predict the recovery rate of gold during the purification process, using data collected from various stages of a gold recovery plant.</p>
<p>The dataset encompasses multiple parameters measured throughout the technological process, including concentrations of different metals (Au, Ag, Pb), particle sizes, and various other features recorded at different stages of purification. These measurements are time-stamped, creating a temporal dimension to our analysis that could reveal important patterns in the recovery process.</p>
<p>The primary objective is to create a model that can accurately predict the recovery rate of gold, which will help optimize the purification process and reduce production costs.</p>
<p>The project’s success will be measured using the Symmetric Mean Absolute Percentage Error (sMAPE), providing a balanced assessment of our model’s predictive capabilities.</p>
<div id="cell-2" class="cell" data-scrolled="false" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-3" class="cell" data-scrolled="false" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the datasets</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.read_csv(<span class="st">'../datasets/gold_recovery_train.csv'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.read_csv(<span class="st">'../datasets/gold_recovery_test.csv'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>full_df <span class="op">=</span> pd.read_csv(<span class="st">'../datasets/gold_recovery_full.csv'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Display basic information about the datasets</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Dataset shapes:"</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Training set: </span><span class="sc">{</span>train_df<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test set: </span><span class="sc">{</span>test_df<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Full set: </span><span class="sc">{</span>full_df<span class="sc">.</span>shape<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Display first few rows of training data</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"First few rows of training data:"</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>train_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset shapes:
Training set: (16860, 87)
Test set: (5856, 53)
Full set: (22716, 87)

First few rows of training data:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">final.output.concentrate_ag</th>
<th data-quarto-table-cell-role="th">final.output.concentrate_pb</th>
<th data-quarto-table-cell-role="th">final.output.concentrate_sol</th>
<th data-quarto-table-cell-role="th">final.output.concentrate_au</th>
<th data-quarto-table-cell-role="th">final.output.recovery</th>
<th data-quarto-table-cell-role="th">final.output.tail_ag</th>
<th data-quarto-table-cell-role="th">final.output.tail_pb</th>
<th data-quarto-table-cell-role="th">final.output.tail_sol</th>
<th data-quarto-table-cell-role="th">final.output.tail_au</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_a_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_a_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_b_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_b_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_a_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_a_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_b_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_b_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank6_a_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank6_a_level</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2016-01-15 00:00:00</td>
<td>6.055403</td>
<td>9.889648</td>
<td>5.507324</td>
<td>42.192020</td>
<td>70.541216</td>
<td>10.411962</td>
<td>0.895447</td>
<td>16.904297</td>
<td>2.143149</td>
<td>...</td>
<td>14.016835</td>
<td>-502.488007</td>
<td>12.099931</td>
<td>-504.715942</td>
<td>9.925633</td>
<td>-498.310211</td>
<td>8.079666</td>
<td>-500.470978</td>
<td>14.151341</td>
<td>-605.841980</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2016-01-15 01:00:00</td>
<td>6.029369</td>
<td>9.968944</td>
<td>5.257781</td>
<td>42.701629</td>
<td>69.266198</td>
<td>10.462676</td>
<td>0.927452</td>
<td>16.634514</td>
<td>2.224930</td>
<td>...</td>
<td>13.992281</td>
<td>-505.503262</td>
<td>11.950531</td>
<td>-501.331529</td>
<td>10.039245</td>
<td>-500.169983</td>
<td>7.984757</td>
<td>-500.582168</td>
<td>13.998353</td>
<td>-599.787184</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2016-01-15 02:00:00</td>
<td>6.055926</td>
<td>10.213995</td>
<td>5.383759</td>
<td>42.657501</td>
<td>68.116445</td>
<td>10.507046</td>
<td>0.953716</td>
<td>16.208849</td>
<td>2.257889</td>
<td>...</td>
<td>14.015015</td>
<td>-502.520901</td>
<td>11.912783</td>
<td>-501.133383</td>
<td>10.070913</td>
<td>-500.129135</td>
<td>8.013877</td>
<td>-500.517572</td>
<td>14.028663</td>
<td>-601.427363</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2016-01-15 03:00:00</td>
<td>6.047977</td>
<td>9.977019</td>
<td>4.858634</td>
<td>42.689819</td>
<td>68.347543</td>
<td>10.422762</td>
<td>0.883763</td>
<td>16.532835</td>
<td>2.146849</td>
<td>...</td>
<td>14.036510</td>
<td>-500.857308</td>
<td>11.999550</td>
<td>-501.193686</td>
<td>9.970366</td>
<td>-499.201640</td>
<td>7.977324</td>
<td>-500.255908</td>
<td>14.005551</td>
<td>-599.996129</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2016-01-15 04:00:00</td>
<td>6.148599</td>
<td>10.142511</td>
<td>4.939416</td>
<td>42.774141</td>
<td>66.927016</td>
<td>10.360302</td>
<td>0.792826</td>
<td>16.525686</td>
<td>2.055292</td>
<td>...</td>
<td>14.027298</td>
<td>-499.838632</td>
<td>11.953070</td>
<td>-501.053894</td>
<td>9.925709</td>
<td>-501.686727</td>
<td>7.894242</td>
<td>-500.356035</td>
<td>13.996647</td>
<td>-601.496691</td>
</tr>
</tbody>
</table>

<p>5 rows × 87 columns</p>
</div>
</div>
</div>
</section>
<section id="recovery-calculation-function" class="level2">
<h2 class="anchored" data-anchor-id="recovery-calculation-function">Recovery Calculation Function</h2>
<p><span class="math display">\[ Recovery = \frac{C \times (F-T)}{F \times (C-T)} \times 100\%  \]</span></p>
<ul>
<li><em>C</em> — share of gold in the concentrate right after flotation (for finding the rougher concentrate recovery)/after purification (for finding the final concentrate recovery)</li>
<li><em>F</em> — share of gold in the feed before flotation (for finding the rougher concentrate recovery)/in the concentrate right after flotation (for finding the final concentrate recovery)</li>
<li><em>T</em> — share of gold in the rougher tails right after flotation (for finding the rougher concentrate recovery)/after purification (for finding the final concentrate recovery)</li>
</ul>
<div id="cell-7" class="cell" data-scrolled="false" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_recovery(row, concentration_col, feed_col, tails_col):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    C <span class="op">=</span> row[concentration_col]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> row[feed_col]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> row[tails_col]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Avoid division by zero</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> F <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> (C <span class="op">-</span> T) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    recovery <span class="op">=</span> C <span class="op">*</span> (F <span class="op">-</span> T) <span class="op">/</span> (F <span class="op">*</span> (C <span class="op">-</span> T)) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle edge cases</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.isnan(recovery) <span class="kw">or</span> np.isinf(recovery):</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> recovery</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-8" class="cell" data-scrolled="false" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate recovery for rougher output</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'calculated_recovery'</span>] <span class="op">=</span> train_df.<span class="bu">apply</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: calculate_recovery(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        row,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rougher.output.concentrate_au'</span>,  <span class="co"># C</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rougher.input.feed_au'</span>,          <span class="co"># F</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rougher.output.tail_au'</span>          <span class="co"># T</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The inclusion of a <code>valid_recovery_mask</code> is a necessary feature in this step to calculate the mean absolute error while the filling step has yet to be conducted at this point, and the missing values will produce errors when running the MAE calculation.</p>
<div id="cell-10" class="cell" data-scrolled="false" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>valid_recovery_mask <span class="op">=</span> (<span class="op">~</span>train_df[<span class="st">'rougher.output.recovery'</span>].isna()) <span class="op">&amp;</span> (<span class="op">~</span>train_df[<span class="st">'calculated_recovery'</span>].isna())</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    train_df.loc[valid_recovery_mask, <span class="st">'rougher.output.recovery'</span>],</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    train_df.loc[valid_recovery_mask, <span class="st">'calculated_recovery'</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MAE between calculated and actual recovery: </span><span class="sc">{</span>mae<span class="sc">:.2e}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE between calculated and actual recovery: 9.30e-15</code></pre>
</div>
</div>
<p>The extremely low Mean Absolute Error (MAE) of 9.30e-15 (effectively zero) confirms that our implementation of the recovery formula perfectly matches the existing recovery calculations in the dataset. This near-zero difference validates both our understanding of the recovery calculation process and the reliability of the provided data, ensuring a solid foundation for our subsequent modeling efforts.</p>
<div id="cell-12" class="cell" data-scrolled="false" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>total_rows <span class="op">=</span> <span class="bu">len</span>(train_df)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>valid_rows <span class="op">=</span> valid_recovery_mask.<span class="bu">sum</span>()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>nan_rows <span class="op">=</span> total_rows <span class="op">-</span> valid_rows</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total rows: </span><span class="sc">{</span>total_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows with valid recovery values: </span><span class="sc">{</span>valid_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows with NaN values: </span><span class="sc">{</span>nan_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Display a few rows with NaN values to understand the pattern</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Example rows with NaN values:"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_df[<span class="op">~</span>valid_recovery_mask][[<span class="st">'rougher.output.recovery'</span>, <span class="st">'calculated_recovery'</span>]].head(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Total rows: 16860
Rows with valid recovery values: 14287
Rows with NaN values: 2573

Example rows with NaN values:
     rougher.output.recovery  calculated_recovery
53                       NaN           188.742102
99                       NaN             0.000000
100                      NaN             0.000000
101                      NaN             0.000000
102                      NaN             0.000000
103                      NaN             0.000000
104                      NaN             0.000000
105                      NaN             0.000000
106                      NaN             0.000000
107                      NaN             0.000000</code></pre>
</div>
</div>
<div id="cell-13" class="cell" data-scrolled="false" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare actual vs calculated recovery values</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>comparison_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Actual Recovery'</span>: train_df[<span class="st">'rougher.output.recovery'</span>],</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Calculated Recovery'</span>: train_df[<span class="st">'calculated_recovery'</span>]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>}).head(<span class="dv">20</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Comparison of first 10 rows:"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>comparison_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Comparison of first 10 rows:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Actual Recovery</th>
<th data-quarto-table-cell-role="th">Calculated Recovery</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>87.107763</td>
<td>87.107763</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>86.843261</td>
<td>86.843261</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>86.842308</td>
<td>86.842308</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>87.226430</td>
<td>87.226430</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>86.688794</td>
<td>86.688794</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>88.156912</td>
<td>88.156912</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>88.168065</td>
<td>88.168065</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>87.668336</td>
<td>87.668336</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>87.035862</td>
<td>87.035862</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>87.650868</td>
<td>87.650868</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>88.280699</td>
<td>88.280699</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>88.499117</td>
<td>88.499117</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>89.299981</td>
<td>89.299981</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>89.519701</td>
<td>89.519701</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>87.235441</td>
<td>87.235441</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>85.136294</td>
<td>85.136294</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>85.443505</td>
<td>85.443505</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>86.489827</td>
<td>86.489827</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>85.462226</td>
<td>85.462226</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>86.241795</td>
<td>86.241795</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The identical values across both columns (ranging from approximately 85% to 89% recovery rates) further confirms the perfect alignment between our calculated recovery values and the actual recorded values in the dataset.</p>
<div id="cell-15" class="cell" data-scrolled="false" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>missing_in_test_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze missing features</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>train_columns <span class="op">=</span> <span class="bu">set</span>(train_df.columns)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>test_columns <span class="op">=</span> <span class="bu">set</span>(test_df.columns)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>missing_in_test <span class="op">=</span> train_columns <span class="op">-</span> test_columns</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get feature types for missing columns</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Features missing in test set:"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> missing_in_test:</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    missing_in_test_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"- </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss"> (Type: </span><span class="sc">{</span>train_df[col]<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Number of columns missing in test set: '</span>, missing_in_test_count)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Features missing in test set:
- final.output.concentrate_ag (Type: float64)
- primary_cleaner.output.tail_pb (Type: float64)
- rougher.calculation.floatbank11_sulfate_to_au_feed (Type: float64)
- rougher.calculation.floatbank10_sulfate_to_au_feed (Type: float64)
- rougher.output.tail_sol (Type: float64)
- rougher.output.concentrate_sol (Type: float64)
- final.output.tail_ag (Type: float64)
- primary_cleaner.output.concentrate_ag (Type: float64)
- rougher.calculation.sulfate_to_au_concentrate (Type: float64)
- rougher.output.tail_pb (Type: float64)
- primary_cleaner.output.tail_ag (Type: float64)
- calculated_recovery (Type: float64)
- rougher.calculation.au_pb_ratio (Type: float64)
- secondary_cleaner.output.tail_sol (Type: float64)
- secondary_cleaner.output.tail_au (Type: float64)
- secondary_cleaner.output.tail_pb (Type: float64)
- primary_cleaner.output.concentrate_sol (Type: float64)
- final.output.concentrate_sol (Type: float64)
- primary_cleaner.output.tail_au (Type: float64)
- final.output.tail_sol (Type: float64)
- rougher.output.recovery (Type: float64)
- primary_cleaner.output.concentrate_au (Type: float64)
- rougher.output.concentrate_au (Type: float64)
- rougher.output.tail_ag (Type: float64)
- final.output.concentrate_pb (Type: float64)
- final.output.concentrate_au (Type: float64)
- final.output.tail_au (Type: float64)
- rougher.output.concentrate_ag (Type: float64)
- primary_cleaner.output.concentrate_pb (Type: float64)
- secondary_cleaner.output.tail_ag (Type: float64)
- rougher.output.concentrate_pb (Type: float64)
- rougher.output.tail_au (Type: float64)
- final.output.recovery (Type: float64)
- final.output.tail_pb (Type: float64)
- primary_cleaner.output.tail_sol (Type: float64)


Number of columns missing in test set:  35</code></pre>
</div>
</div>
<ol type="1">
<li><p>Recovery Measurements:</p>
<ul>
<li>Recovery measurements (<code>rougher.output.recovery</code>, <code>final.output.recovery</code>, <code>calculated_recovery</code>)</li>
<li>Final output concentrations for various minerals (Au, Ag, Pb)</li>
</ul></li>
<li><p>Process Measurements:</p>
<ul>
<li>Concentrate measurements at different stages (<code>primary_cleaner</code>, <code>secondary_cleaner</code>, <code>rougher</code>)</li>
<li>Tail measurements across various processing stages</li>
<li>Solution (sol) concentrations at different points</li>
</ul></li>
<li><p>Calculated Parameters:</p>
<ul>
<li>Sulfate-to-gold ratios (<code>floatbank10_sulfate_to_au_feed</code>, <code>floatbank11_sulfate_to_au_feed</code>)</li>
<li>Gold-to-lead ratios (<code>au_pb_ratio</code>)</li>
</ul></li>
</ol>
<div id="cell-17" class="cell" data-scrolled="false" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic data quality checks</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Missing values in training set:"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_df.isnull().<span class="bu">sum</span>()[train_df.isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Missing values in test set:"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_df.isnull().<span class="bu">sum</span>()[test_df.isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Missing values in training set:
final.output.concentrate_ag                     72
final.output.concentrate_pb                     72
final.output.concentrate_sol                   370
final.output.concentrate_au                     71
final.output.recovery                         1521
                                              ... 
secondary_cleaner.state.floatbank5_a_level      85
secondary_cleaner.state.floatbank5_b_air        85
secondary_cleaner.state.floatbank5_b_level      84
secondary_cleaner.state.floatbank6_a_air       103
secondary_cleaner.state.floatbank6_a_level      85
Length: 85, dtype: int64

Missing values in test set:
primary_cleaner.input.sulfate                 302
primary_cleaner.input.depressant              284
primary_cleaner.input.xanthate                166
primary_cleaner.state.floatbank8_a_air         16
primary_cleaner.state.floatbank8_a_level       16
primary_cleaner.state.floatbank8_b_air         16
primary_cleaner.state.floatbank8_b_level       16
primary_cleaner.state.floatbank8_c_air         16
primary_cleaner.state.floatbank8_c_level       16
primary_cleaner.state.floatbank8_d_air         16
primary_cleaner.state.floatbank8_d_level       16
rougher.input.feed_ag                          16
rougher.input.feed_pb                          16
rougher.input.feed_rate                        40
rougher.input.feed_size                        22
rougher.input.feed_sol                         67
rougher.input.feed_au                          16
rougher.input.floatbank10_sulfate             257
rougher.input.floatbank10_xanthate            123
rougher.input.floatbank11_sulfate              55
rougher.input.floatbank11_xanthate            353
rougher.state.floatbank10_a_air                17
rougher.state.floatbank10_a_level              16
rougher.state.floatbank10_b_air                17
rougher.state.floatbank10_b_level              16
rougher.state.floatbank10_c_air                17
rougher.state.floatbank10_c_level              16
rougher.state.floatbank10_d_air                17
rougher.state.floatbank10_d_level              16
rougher.state.floatbank10_e_air                17
rougher.state.floatbank10_e_level              16
rougher.state.floatbank10_f_air                17
rougher.state.floatbank10_f_level              16
secondary_cleaner.state.floatbank2_a_air       20
secondary_cleaner.state.floatbank2_a_level     16
secondary_cleaner.state.floatbank2_b_air       23
secondary_cleaner.state.floatbank2_b_level     16
secondary_cleaner.state.floatbank3_a_air       34
secondary_cleaner.state.floatbank3_a_level     16
secondary_cleaner.state.floatbank3_b_air       16
secondary_cleaner.state.floatbank3_b_level     16
secondary_cleaner.state.floatbank4_a_air       16
secondary_cleaner.state.floatbank4_a_level     16
secondary_cleaner.state.floatbank4_b_air       16
secondary_cleaner.state.floatbank4_b_level     16
secondary_cleaner.state.floatbank5_a_air       16
secondary_cleaner.state.floatbank5_a_level     16
secondary_cleaner.state.floatbank5_b_air       16
secondary_cleaner.state.floatbank5_b_level     16
secondary_cleaner.state.floatbank6_a_air       16
secondary_cleaner.state.floatbank6_a_level     16
dtype: int64</code></pre>
</div>
</div>
<p>Here we highlight the inherent challenges in industrial process data collection. The training set exhibits 85 columns with missing values, with significant gaps in final output measurements and recovery data, notably 1,521 missing values in final output recovery. State measurements such as floatbank levels and air parameters show consistent patterns of 85-103 missing entries. The test set demonstrates a more extensive pattern of missing values, particularly in input and state parameters. While floatbank state measurements consistently show around 16 missing values, chemical input measurements display higher variability in missing data, ranging from 166 to 353 missing values for xanthate measurements and up to 302 for sulfate readings. Feed measurements also show varying degrees of missingness across different parameters.</p>
</section>
<section id="missing-data-imputation" class="level1">
<h1>Missing Data Imputation</h1>
<section id="experiment" class="level2">
<h2 class="anchored" data-anchor-id="experiment">Experiment</h2>
<p><strong>Rolling average interpolation</strong> is an approach to handling missing values in time-series data that’s particularly relevant for continuous industrial processes like gold recovery. The function creates a bidirectional moving average by computing both forward and backward rolling means with a specified window size (default 100 points), then averages these two directions to produce more balanced estimates.</p>
<p><span class="math display">\[ Combined_Average(t) = \frac{1}{2} (\frac{\sum_{i=t}^{t+w} X_i}{w} + \frac{\sum_{i=t-w}^{t} X_i}{w}) \]</span></p>
<ul>
<li><span class="math inline">\(w\)</span> = window size (100)</li>
<li><span class="math inline">\(t\)</span> = current time point</li>
<li><span class="math inline">\(X_i\)</span> = value at time i</li>
</ul>
<div id="cell-23" class="cell" data-scrolled="false" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rolling_average_interpolate(series, window<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create forward and backward rolling means</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    forward_roll <span class="op">=</span> series.rolling(window<span class="op">=</span>window, min_periods<span class="op">=</span><span class="dv">1</span>).mean()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    backward_roll <span class="op">=</span> series[::<span class="op">-</span><span class="dv">1</span>].rolling(window<span class="op">=</span>window, min_periods<span class="op">=</span><span class="dv">1</span>).mean()[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine forward and backward rolls</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    combined_roll <span class="op">=</span> (forward_roll <span class="op">+</span> backward_roll) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only fill the NaN values in the original series</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> series.copy()</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    result[series.isna()] <span class="op">=</span> combined_roll[series.isna()]</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-24" class="cell" data-scrolled="false" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_fill_effects(df, columns_to_check<span class="op">=</span><span class="va">None</span>, sample_size<span class="op">=</span><span class="dv">200</span>, rolling_window<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no columns specified, find columns with missing values</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> columns_to_check <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        columns_to_check <span class="op">=</span> df.columns[df.isna().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Take top 3 columns with most missing values</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        columns_to_check <span class="op">=</span> columns_to_check[df[columns_to_check].isna().<span class="bu">sum</span>().nlargest(<span class="dv">3</span>).index]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> column <span class="kw">in</span> columns_to_check:</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create different versions of the data</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        original <span class="op">=</span> df[column].copy()</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        ffill_bfill <span class="op">=</span> df[column].ffill().bfill()</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        rolling_fill <span class="op">=</span> rolling_average_interpolate(original, window<span class="op">=</span>rolling_window)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get indexes where values were originally missing</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        missing_idx <span class="op">=</span> original.isna()</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot 1: Line plot showing original vs filled values</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        sample_idx <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="bu">len</span>(original)<span class="op">-</span><span class="dv">1</span>, sample_size).astype(<span class="bu">int</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot lines</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        plt.plot(ffill_bfill.iloc[sample_idx], <span class="st">'--'</span>, </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'Forward + Backward Fill'</span>, </span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">"#48c9b0"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        plt.plot(rolling_fill.iloc[sample_idx], <span class="st">'--'</span>,</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'Rolling Average (window=</span><span class="sc">{</span>rolling_window<span class="sc">}</span><span class="ss">)'</span>,</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">"#3498db"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        plt.plot(original.iloc[sample_idx], <span class="st">'o-'</span>, </span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'Original'</span>, </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">"#121314"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Highlight missing values for all methods</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        missing_samples <span class="op">=</span> missing_idx.iloc[sample_idx]</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        plt.scatter(missing_samples[missing_samples].index,</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>                   ffill_bfill.iloc[sample_idx][missing_samples],</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span><span class="st">'#48c9b0'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span><span class="st">'FB Fill Points'</span>)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        plt.scatter(missing_samples[missing_samples].index,</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>                   rolling_fill.iloc[sample_idx][missing_samples],</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span><span class="st">'#3498db'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span><span class="st">'Rolling Fill Points'</span>)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'Timeline View for </span><span class="sc">{</span>column<span class="sc">}</span><span class="ss"> (n = 200)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Sample Index'</span>)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Value'</span>)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot 2: Distribution plot</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>        sns.kdeplot(data<span class="op">=</span>original.dropna(),</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span><span class="st">'Original Distribution'</span>, </span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span><span class="st">"#121314"</span>, alpha<span class="op">=</span><span class="fl">.5</span>)</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        sns.kdeplot(data<span class="op">=</span>ffill_bfill,</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span><span class="st">'Forward + Backward Fill Distribution'</span>, </span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span><span class="st">"#48c9b0"</span>, alpha<span class="op">=</span><span class="fl">.5</span>)</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>        sns.kdeplot(data<span class="op">=</span>rolling_fill,</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span><span class="st">'Rolling Average Distribution'</span>,</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span><span class="st">"#3498db"</span>, alpha<span class="op">=</span><span class="fl">.5</span>)</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'Distribution Comparison for </span><span class="sc">{</span>column<span class="sc">}</span><span class="ss">'</span>, fontsize<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Value'</span>)</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Density'</span>)</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-25" class="cell" data-scrolled="false" data-execution_count="13">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to the training data</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>missing_counts <span class="op">=</span> train_df.isnull().<span class="bu">sum</span>()</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>significant_missing <span class="op">=</span> missing_counts[missing_counts <span class="op">&gt;</span> <span class="bu">len</span>(train_df) <span class="op">*</span> <span class="fl">0.05</span>].index.tolist()[:<span class="dv">3</span>] <span class="co"># Delegate imputation experiementation to the usual suspects</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Columns with significant missing values:"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> significant_missing:</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>missing_counts[col]<span class="sc">}</span><span class="ss"> missing values"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Columns with significant missing values:
final.output.recovery: 1521 missing values
primary_cleaner.input.sulfate: 1307 missing values
primary_cleaner.input.depressant: 1262 missing values</code></pre>
</div>
</div>
<div id="cell-26" class="cell" data-scrolled="false" data-execution_count="14">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>visualize_fill_effects(train_df, significant_missing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-14-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-14-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-14-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-14-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Firstly, <strong>Polynomial Interpolation</strong> is not an appropriate method to fill in the missing values in this case because of the many relationships established between the variables which exist and are important. If we were to design some sort of <em>process aware polynomial interpolation</em> perhaps with a more encompasing method, one could find success in imputing the missing values throughout all the features.</p>
<p><strong>Polynomial Interpolation was experimented with but did not pass the quality tests under these many missing conditions.</strong></p>
<p>Between <strong>Forward + Backward Fill</strong> and <strong>Rolling Average Interpolation</strong>, the latter appears to moreso maintain the existing distribution patterns of the features while not filling up the zeroes. To carry this on I will be utilizing an ensemble of interpolation methods (<strong>Rolling Average Interpolation</strong> &amp; <strong>Forward + Backward Fill</strong>) in order to fill in the missing values throughout the dataset.</p>
</section>
<section id="application" class="level2">
<h2 class="anchored" data-anchor-id="application">Application</h2>
<div id="cell-29" class="cell" data-scrolled="false" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a copy of the dataframe to store filled values</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>filled_train_df <span class="op">=</span> train_df.copy()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>filled_test_df <span class="op">=</span> test_df.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-30" class="cell" data-scrolled="false" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate numeric and non-numeric columns</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>numeric_columns <span class="op">=</span> train_df.select_dtypes(include<span class="op">=</span>[np.number]).columns</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>non_numeric_columns <span class="op">=</span> train_df.select_dtypes(exclude<span class="op">=</span>[np.number]).columns</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>test_numeric_columns <span class="op">=</span> test_df.select_dtypes(include<span class="op">=</span>[np.number]).columns</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>test_non_numeric_columns <span class="op">=</span> test_df.select_dtypes(exclude<span class="op">=</span>[np.number]).columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-31" class="cell" data-scrolled="false" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to apply multiple interpolation and choose best one.</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> advanced_fill(series):</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try different window sizes for rolling average</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    windows <span class="op">=</span> [<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    best_filled <span class="op">=</span> <span class="va">None</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    least_missing <span class="op">=</span> <span class="bu">float</span>(<span class="st">'inf'</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> window <span class="kw">in</span> windows:</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        filled <span class="op">=</span> rolling_average_interpolate(series, window<span class="op">=</span>window)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        missing_count <span class="op">=</span> filled.isnull().<span class="bu">sum</span>()</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> missing_count <span class="op">&lt;</span> least_missing:</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>            least_missing <span class="op">=</span> missing_count</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>            best_filled <span class="op">=</span> filled</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final fallback: forward fill and backward fill</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_filled.isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        best_filled <span class="op">=</span> best_filled.ffill().bfill()</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best_filled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fill-training-data" class="level3">
<h3 class="anchored" data-anchor-id="fill-training-data">Fill Training Data</h3>
<div id="cell-33" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Initial missing values: </span><span class="sc">{</span>filled_train_df<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill non-numeric columns</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling non-numeric columns..."</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> non_numeric_columns:</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    filled_train_df[column] <span class="op">=</span> filled_train_df[column].ffill().bfill()</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill numeric columns with advanced method</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling numeric columns..."</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> numeric_columns:</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    original_missing <span class="op">=</span> filled_train_df[column].isnull().<span class="bu">sum</span>()</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> original_missing <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        filled_train_df[column] <span class="op">=</span> advanced_fill(filled_train_df[column])</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        remaining_missing <span class="op">=</span> filled_train_df[column].isnull().<span class="bu">sum</span>()</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Final verification</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>final_missing <span class="op">=</span> filled_train_df.isnull().<span class="bu">sum</span>().<span class="bu">sum</span>()</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Final verification:"</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total missing values before: </span><span class="sc">{</span>train_df<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total missing values after: </span><span class="sc">{</span>final_missing<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co"># The filled dataframe is now stored in 'filled_train_df'</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filled dataframe is stored in 'filled_train_df' variable"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial missing values: 30320

Filling non-numeric columns...

Filling numeric columns...

Final verification:
Total missing values before: 30320
Total missing values after: 0

Filled dataframe is stored in 'filled_train_df' variable</code></pre>
</div>
</div>
</section>
<section id="fill-testing-data" class="level3">
<h3 class="anchored" data-anchor-id="fill-testing-data">Fill Testing Data</h3>
<div id="cell-35" class="cell" data-scrolled="true" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Initial missing values: </span><span class="sc">{</span>filled_test_df<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill non-numeric columns</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling non-numeric columns..."</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> test_non_numeric_columns:</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    filled_test_df[column] <span class="op">=</span> filled_test_df[column].ffill().bfill()</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill numeric columns with advanced method</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling numeric columns..."</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> test_numeric_columns:</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    original_missing <span class="op">=</span> filled_test_df[column].isnull().<span class="bu">sum</span>()</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> original_missing <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        filled_test_df[column] <span class="op">=</span> advanced_fill(filled_test_df[column])</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        remaining_missing <span class="op">=</span> filled_test_df[column].isnull().<span class="bu">sum</span>()</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Final verification</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>final_missing <span class="op">=</span> filled_test_df.isnull().<span class="bu">sum</span>().<span class="bu">sum</span>()</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Final verification:"</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total missing values before: </span><span class="sc">{</span>test_df<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total missing values after: </span><span class="sc">{</span>final_missing<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="co"># The filled dataframe is now stored in 'filled_test_df'</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filled dataframe is stored in 'filled_test_df' variable"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial missing values: 2360

Filling non-numeric columns...

Filling numeric columns...

Final verification:
Total missing values before: 2360
Total missing values after: 0

Filled dataframe is stored in 'filled_test_df' variable</code></pre>
</div>
</div>
</section>
<section id="forward-only-advanced-fill-bfill-induced-data-leakage-sanity-check" class="level3">
<h3 class="anchored" data-anchor-id="forward-only-advanced-fill-bfill-induced-data-leakage-sanity-check">Forward Only Advanced Fill (<code>bfill</code> induced data leakage sanity check)</h3>
<div id="cell-37" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>ffill_train_df <span class="op">=</span> train_df.copy()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>ffill_test_df <span class="op">=</span> test_df.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-38" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_only_fill(series):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    windows <span class="op">=</span> [<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    best_filled <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    least_missing <span class="op">=</span> <span class="bu">float</span>(<span class="st">'inf'</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> window <span class="kw">in</span> windows:</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        filled <span class="op">=</span> rolling_average_interpolate(series, window<span class="op">=</span>window)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        missing_count <span class="op">=</span> filled.isnull().<span class="bu">sum</span>()</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> missing_count <span class="op">&lt;</span> least_missing:</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>            least_missing <span class="op">=</span> missing_count</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>            best_filled <span class="op">=</span> filled</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final fallback: forward fill only</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_filled.isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        best_filled <span class="op">=</span> best_filled.ffill()</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best_filled</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Initial missing values: </span><span class="sc">{</span>ffill_train_df<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial missing values: 30320</code></pre>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill non-numeric columns</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling non-numeric columns..."</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> non_numeric_columns:</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    ffill_train_df[column] <span class="op">=</span> ffill_train_df[column].ffill()  <span class="co"># Only forward fill</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill numeric columns with advanced method</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling numeric columns..."</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> numeric_columns:</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    original_missing <span class="op">=</span> ffill_train_df[column].isnull().<span class="bu">sum</span>()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> original_missing <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        ffill_train_df[column] <span class="op">=</span> forward_only_fill(ffill_train_df[column])</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        remaining_missing <span class="op">=</span> ffill_train_df[column].isnull().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Filling non-numeric columns...

Filling numeric columns...</code></pre>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Final verification</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>final_missing <span class="op">=</span> ffill_train_df.isnull().<span class="bu">sum</span>().<span class="bu">sum</span>()</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Final verification:"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total missing values before: </span><span class="sc">{</span>train_df<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total missing values after: </span><span class="sc">{</span>final_missing<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Final verification:
Total missing values before: 30320
Total missing values after: 0</code></pre>
</div>
</div>
<div id="cell-41" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process test data</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Initial missing values in test: </span><span class="sc">{</span>ffill_test_df<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill non-numeric columns</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling non-numeric columns..."</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> test_non_numeric_columns:</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    ffill_test_df[column] <span class="op">=</span> ffill_test_df[column].ffill()</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill numeric columns with advanced method</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling numeric columns..."</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> test_numeric_columns:</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    original_missing <span class="op">=</span> ffill_test_df[column].isnull().<span class="bu">sum</span>()</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> original_missing <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        ffill_test_df[column] <span class="op">=</span> forward_only_fill(ffill_test_df[column])</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        remaining_missing <span class="op">=</span> ffill_test_df[column].isnull().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Initial missing values in test: 2360

Filling non-numeric columns...

Filling numeric columns...</code></pre>
</div>
</div>
</section>
<section id="filled-data-inspection" class="level3">
<h3 class="anchored" data-anchor-id="filled-data-inspection">Filled Data Inspection</h3>
<div id="cell-43" class="cell" data-scrolled="true" data-execution_count="25">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>display(filled_train_df.head())</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>filled_test_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">final.output.concentrate_ag</th>
<th data-quarto-table-cell-role="th">final.output.concentrate_pb</th>
<th data-quarto-table-cell-role="th">final.output.concentrate_sol</th>
<th data-quarto-table-cell-role="th">final.output.concentrate_au</th>
<th data-quarto-table-cell-role="th">final.output.recovery</th>
<th data-quarto-table-cell-role="th">final.output.tail_ag</th>
<th data-quarto-table-cell-role="th">final.output.tail_pb</th>
<th data-quarto-table-cell-role="th">final.output.tail_sol</th>
<th data-quarto-table-cell-role="th">final.output.tail_au</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_a_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_b_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_b_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_a_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_a_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_b_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_b_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank6_a_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank6_a_level</th>
<th data-quarto-table-cell-role="th">calculated_recovery</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2016-01-15 00:00:00</td>
<td>6.055403</td>
<td>9.889648</td>
<td>5.507324</td>
<td>42.192020</td>
<td>70.541216</td>
<td>10.411962</td>
<td>0.895447</td>
<td>16.904297</td>
<td>2.143149</td>
<td>...</td>
<td>-502.488007</td>
<td>12.099931</td>
<td>-504.715942</td>
<td>9.925633</td>
<td>-498.310211</td>
<td>8.079666</td>
<td>-500.470978</td>
<td>14.151341</td>
<td>-605.841980</td>
<td>87.107763</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2016-01-15 01:00:00</td>
<td>6.029369</td>
<td>9.968944</td>
<td>5.257781</td>
<td>42.701629</td>
<td>69.266198</td>
<td>10.462676</td>
<td>0.927452</td>
<td>16.634514</td>
<td>2.224930</td>
<td>...</td>
<td>-505.503262</td>
<td>11.950531</td>
<td>-501.331529</td>
<td>10.039245</td>
<td>-500.169983</td>
<td>7.984757</td>
<td>-500.582168</td>
<td>13.998353</td>
<td>-599.787184</td>
<td>86.843261</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2016-01-15 02:00:00</td>
<td>6.055926</td>
<td>10.213995</td>
<td>5.383759</td>
<td>42.657501</td>
<td>68.116445</td>
<td>10.507046</td>
<td>0.953716</td>
<td>16.208849</td>
<td>2.257889</td>
<td>...</td>
<td>-502.520901</td>
<td>11.912783</td>
<td>-501.133383</td>
<td>10.070913</td>
<td>-500.129135</td>
<td>8.013877</td>
<td>-500.517572</td>
<td>14.028663</td>
<td>-601.427363</td>
<td>86.842308</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2016-01-15 03:00:00</td>
<td>6.047977</td>
<td>9.977019</td>
<td>4.858634</td>
<td>42.689819</td>
<td>68.347543</td>
<td>10.422762</td>
<td>0.883763</td>
<td>16.532835</td>
<td>2.146849</td>
<td>...</td>
<td>-500.857308</td>
<td>11.999550</td>
<td>-501.193686</td>
<td>9.970366</td>
<td>-499.201640</td>
<td>7.977324</td>
<td>-500.255908</td>
<td>14.005551</td>
<td>-599.996129</td>
<td>87.226430</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2016-01-15 04:00:00</td>
<td>6.148599</td>
<td>10.142511</td>
<td>4.939416</td>
<td>42.774141</td>
<td>66.927016</td>
<td>10.360302</td>
<td>0.792826</td>
<td>16.525686</td>
<td>2.055292</td>
<td>...</td>
<td>-499.838632</td>
<td>11.953070</td>
<td>-501.053894</td>
<td>9.925709</td>
<td>-501.686727</td>
<td>7.894242</td>
<td>-500.356035</td>
<td>13.996647</td>
<td>-601.496691</td>
<td>86.688794</td>
</tr>
</tbody>
</table>

<p>5 rows × 88 columns</p>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">primary_cleaner.input.sulfate</th>
<th data-quarto-table-cell-role="th">primary_cleaner.input.depressant</th>
<th data-quarto-table-cell-role="th">primary_cleaner.input.feed_size</th>
<th data-quarto-table-cell-role="th">primary_cleaner.input.xanthate</th>
<th data-quarto-table-cell-role="th">primary_cleaner.state.floatbank8_a_air</th>
<th data-quarto-table-cell-role="th">primary_cleaner.state.floatbank8_a_level</th>
<th data-quarto-table-cell-role="th">primary_cleaner.state.floatbank8_b_air</th>
<th data-quarto-table-cell-role="th">primary_cleaner.state.floatbank8_b_level</th>
<th data-quarto-table-cell-role="th">primary_cleaner.state.floatbank8_c_air</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_a_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_a_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_b_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank4_b_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_a_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_a_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_b_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank5_b_level</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank6_a_air</th>
<th data-quarto-table-cell-role="th">secondary_cleaner.state.floatbank6_a_level</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2016-09-01 00:59:59</td>
<td>210.800909</td>
<td>14.993118</td>
<td>8.080000</td>
<td>1.005021</td>
<td>1398.981301</td>
<td>-500.225577</td>
<td>1399.144926</td>
<td>-499.919735</td>
<td>1400.102998</td>
<td>...</td>
<td>12.023554</td>
<td>-497.795834</td>
<td>8.016656</td>
<td>-501.289139</td>
<td>7.946562</td>
<td>-432.317850</td>
<td>4.872511</td>
<td>-500.037437</td>
<td>26.705889</td>
<td>-499.709414</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2016-09-01 01:59:59</td>
<td>215.392455</td>
<td>14.987471</td>
<td>8.080000</td>
<td>0.990469</td>
<td>1398.777912</td>
<td>-500.057435</td>
<td>1398.055362</td>
<td>-499.778182</td>
<td>1396.151033</td>
<td>...</td>
<td>12.058140</td>
<td>-498.695773</td>
<td>8.130979</td>
<td>-499.634209</td>
<td>7.958270</td>
<td>-525.839648</td>
<td>4.878850</td>
<td>-500.162375</td>
<td>25.019940</td>
<td>-499.819438</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2016-09-01 02:59:59</td>
<td>215.259946</td>
<td>12.884934</td>
<td>7.786667</td>
<td>0.996043</td>
<td>1398.493666</td>
<td>-500.868360</td>
<td>1398.860436</td>
<td>-499.764529</td>
<td>1398.075709</td>
<td>...</td>
<td>11.962366</td>
<td>-498.767484</td>
<td>8.096893</td>
<td>-500.827423</td>
<td>8.071056</td>
<td>-500.801673</td>
<td>4.905125</td>
<td>-499.828510</td>
<td>24.994862</td>
<td>-500.622559</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2016-09-01 03:59:59</td>
<td>215.336236</td>
<td>12.006805</td>
<td>7.640000</td>
<td>0.863514</td>
<td>1399.618111</td>
<td>-498.863574</td>
<td>1397.440120</td>
<td>-499.211024</td>
<td>1400.129303</td>
<td>...</td>
<td>12.033091</td>
<td>-498.350935</td>
<td>8.074946</td>
<td>-499.474407</td>
<td>7.897085</td>
<td>-500.868509</td>
<td>4.931400</td>
<td>-499.963623</td>
<td>24.948919</td>
<td>-498.709987</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2016-09-01 04:59:59</td>
<td>199.099327</td>
<td>10.682530</td>
<td>7.530000</td>
<td>0.805575</td>
<td>1401.268123</td>
<td>-500.808305</td>
<td>1398.128818</td>
<td>-499.504543</td>
<td>1402.172226</td>
<td>...</td>
<td>12.025367</td>
<td>-500.786497</td>
<td>8.054678</td>
<td>-500.397500</td>
<td>8.107890</td>
<td>-509.526725</td>
<td>4.957674</td>
<td>-500.360026</td>
<td>25.003331</td>
<td>-500.856333</td>
</tr>
</tbody>
</table>

<p>5 rows × 53 columns</p>
</div>
</div>
</div>
<div id="cell-44" class="cell" data-scrolled="true" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>display(filled_train_df.info())</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>filled_test_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 16860 entries, 0 to 16859
Data columns (total 88 columns):
 #   Column                                              Non-Null Count  Dtype  
---  ------                                              --------------  -----  
 0   date                                                16860 non-null  object 
 1   final.output.concentrate_ag                         16860 non-null  float64
 2   final.output.concentrate_pb                         16860 non-null  float64
 3   final.output.concentrate_sol                        16860 non-null  float64
 4   final.output.concentrate_au                         16860 non-null  float64
 5   final.output.recovery                               16860 non-null  float64
 6   final.output.tail_ag                                16860 non-null  float64
 7   final.output.tail_pb                                16860 non-null  float64
 8   final.output.tail_sol                               16860 non-null  float64
 9   final.output.tail_au                                16860 non-null  float64
 10  primary_cleaner.input.sulfate                       16860 non-null  float64
 11  primary_cleaner.input.depressant                    16860 non-null  float64
 12  primary_cleaner.input.feed_size                     16860 non-null  float64
 13  primary_cleaner.input.xanthate                      16860 non-null  float64
 14  primary_cleaner.output.concentrate_ag               16860 non-null  float64
 15  primary_cleaner.output.concentrate_pb               16860 non-null  float64
 16  primary_cleaner.output.concentrate_sol              16860 non-null  float64
 17  primary_cleaner.output.concentrate_au               16860 non-null  float64
 18  primary_cleaner.output.tail_ag                      16860 non-null  float64
 19  primary_cleaner.output.tail_pb                      16860 non-null  float64
 20  primary_cleaner.output.tail_sol                     16860 non-null  float64
 21  primary_cleaner.output.tail_au                      16860 non-null  float64
 22  primary_cleaner.state.floatbank8_a_air              16860 non-null  float64
 23  primary_cleaner.state.floatbank8_a_level            16860 non-null  float64
 24  primary_cleaner.state.floatbank8_b_air              16860 non-null  float64
 25  primary_cleaner.state.floatbank8_b_level            16860 non-null  float64
 26  primary_cleaner.state.floatbank8_c_air              16860 non-null  float64
 27  primary_cleaner.state.floatbank8_c_level            16860 non-null  float64
 28  primary_cleaner.state.floatbank8_d_air              16860 non-null  float64
 29  primary_cleaner.state.floatbank8_d_level            16860 non-null  float64
 30  rougher.calculation.sulfate_to_au_concentrate       16860 non-null  float64
 31  rougher.calculation.floatbank10_sulfate_to_au_feed  16860 non-null  float64
 32  rougher.calculation.floatbank11_sulfate_to_au_feed  16860 non-null  float64
 33  rougher.calculation.au_pb_ratio                     16860 non-null  float64
 34  rougher.input.feed_ag                               16860 non-null  float64
 35  rougher.input.feed_pb                               16860 non-null  float64
 36  rougher.input.feed_rate                             16860 non-null  float64
 37  rougher.input.feed_size                             16860 non-null  float64
 38  rougher.input.feed_sol                              16860 non-null  float64
 39  rougher.input.feed_au                               16860 non-null  float64
 40  rougher.input.floatbank10_sulfate                   16860 non-null  float64
 41  rougher.input.floatbank10_xanthate                  16860 non-null  float64
 42  rougher.input.floatbank11_sulfate                   16860 non-null  float64
 43  rougher.input.floatbank11_xanthate                  16860 non-null  float64
 44  rougher.output.concentrate_ag                       16860 non-null  float64
 45  rougher.output.concentrate_pb                       16860 non-null  float64
 46  rougher.output.concentrate_sol                      16860 non-null  float64
 47  rougher.output.concentrate_au                       16860 non-null  float64
 48  rougher.output.recovery                             16860 non-null  float64
 49  rougher.output.tail_ag                              16860 non-null  float64
 50  rougher.output.tail_pb                              16860 non-null  float64
 51  rougher.output.tail_sol                             16860 non-null  float64
 52  rougher.output.tail_au                              16860 non-null  float64
 53  rougher.state.floatbank10_a_air                     16860 non-null  float64
 54  rougher.state.floatbank10_a_level                   16860 non-null  float64
 55  rougher.state.floatbank10_b_air                     16860 non-null  float64
 56  rougher.state.floatbank10_b_level                   16860 non-null  float64
 57  rougher.state.floatbank10_c_air                     16860 non-null  float64
 58  rougher.state.floatbank10_c_level                   16860 non-null  float64
 59  rougher.state.floatbank10_d_air                     16860 non-null  float64
 60  rougher.state.floatbank10_d_level                   16860 non-null  float64
 61  rougher.state.floatbank10_e_air                     16860 non-null  float64
 62  rougher.state.floatbank10_e_level                   16860 non-null  float64
 63  rougher.state.floatbank10_f_air                     16860 non-null  float64
 64  rougher.state.floatbank10_f_level                   16860 non-null  float64
 65  secondary_cleaner.output.tail_ag                    16860 non-null  float64
 66  secondary_cleaner.output.tail_pb                    16860 non-null  float64
 67  secondary_cleaner.output.tail_sol                   16860 non-null  float64
 68  secondary_cleaner.output.tail_au                    16860 non-null  float64
 69  secondary_cleaner.state.floatbank2_a_air            16860 non-null  float64
 70  secondary_cleaner.state.floatbank2_a_level          16860 non-null  float64
 71  secondary_cleaner.state.floatbank2_b_air            16860 non-null  float64
 72  secondary_cleaner.state.floatbank2_b_level          16860 non-null  float64
 73  secondary_cleaner.state.floatbank3_a_air            16860 non-null  float64
 74  secondary_cleaner.state.floatbank3_a_level          16860 non-null  float64
 75  secondary_cleaner.state.floatbank3_b_air            16860 non-null  float64
 76  secondary_cleaner.state.floatbank3_b_level          16860 non-null  float64
 77  secondary_cleaner.state.floatbank4_a_air            16860 non-null  float64
 78  secondary_cleaner.state.floatbank4_a_level          16860 non-null  float64
 79  secondary_cleaner.state.floatbank4_b_air            16860 non-null  float64
 80  secondary_cleaner.state.floatbank4_b_level          16860 non-null  float64
 81  secondary_cleaner.state.floatbank5_a_air            16860 non-null  float64
 82  secondary_cleaner.state.floatbank5_a_level          16860 non-null  float64
 83  secondary_cleaner.state.floatbank5_b_air            16860 non-null  float64
 84  secondary_cleaner.state.floatbank5_b_level          16860 non-null  float64
 85  secondary_cleaner.state.floatbank6_a_air            16860 non-null  float64
 86  secondary_cleaner.state.floatbank6_a_level          16860 non-null  float64
 87  calculated_recovery                                 16860 non-null  float64
dtypes: float64(87), object(1)
memory usage: 11.3+ MB</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>None</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 5856 entries, 0 to 5855
Data columns (total 53 columns):
 #   Column                                      Non-Null Count  Dtype  
---  ------                                      --------------  -----  
 0   date                                        5856 non-null   object 
 1   primary_cleaner.input.sulfate               5856 non-null   float64
 2   primary_cleaner.input.depressant            5856 non-null   float64
 3   primary_cleaner.input.feed_size             5856 non-null   float64
 4   primary_cleaner.input.xanthate              5856 non-null   float64
 5   primary_cleaner.state.floatbank8_a_air      5856 non-null   float64
 6   primary_cleaner.state.floatbank8_a_level    5856 non-null   float64
 7   primary_cleaner.state.floatbank8_b_air      5856 non-null   float64
 8   primary_cleaner.state.floatbank8_b_level    5856 non-null   float64
 9   primary_cleaner.state.floatbank8_c_air      5856 non-null   float64
 10  primary_cleaner.state.floatbank8_c_level    5856 non-null   float64
 11  primary_cleaner.state.floatbank8_d_air      5856 non-null   float64
 12  primary_cleaner.state.floatbank8_d_level    5856 non-null   float64
 13  rougher.input.feed_ag                       5856 non-null   float64
 14  rougher.input.feed_pb                       5856 non-null   float64
 15  rougher.input.feed_rate                     5856 non-null   float64
 16  rougher.input.feed_size                     5856 non-null   float64
 17  rougher.input.feed_sol                      5856 non-null   float64
 18  rougher.input.feed_au                       5856 non-null   float64
 19  rougher.input.floatbank10_sulfate           5856 non-null   float64
 20  rougher.input.floatbank10_xanthate          5856 non-null   float64
 21  rougher.input.floatbank11_sulfate           5856 non-null   float64
 22  rougher.input.floatbank11_xanthate          5856 non-null   float64
 23  rougher.state.floatbank10_a_air             5856 non-null   float64
 24  rougher.state.floatbank10_a_level           5856 non-null   float64
 25  rougher.state.floatbank10_b_air             5856 non-null   float64
 26  rougher.state.floatbank10_b_level           5856 non-null   float64
 27  rougher.state.floatbank10_c_air             5856 non-null   float64
 28  rougher.state.floatbank10_c_level           5856 non-null   float64
 29  rougher.state.floatbank10_d_air             5856 non-null   float64
 30  rougher.state.floatbank10_d_level           5856 non-null   float64
 31  rougher.state.floatbank10_e_air             5856 non-null   float64
 32  rougher.state.floatbank10_e_level           5856 non-null   float64
 33  rougher.state.floatbank10_f_air             5856 non-null   float64
 34  rougher.state.floatbank10_f_level           5856 non-null   float64
 35  secondary_cleaner.state.floatbank2_a_air    5856 non-null   float64
 36  secondary_cleaner.state.floatbank2_a_level  5856 non-null   float64
 37  secondary_cleaner.state.floatbank2_b_air    5856 non-null   float64
 38  secondary_cleaner.state.floatbank2_b_level  5856 non-null   float64
 39  secondary_cleaner.state.floatbank3_a_air    5856 non-null   float64
 40  secondary_cleaner.state.floatbank3_a_level  5856 non-null   float64
 41  secondary_cleaner.state.floatbank3_b_air    5856 non-null   float64
 42  secondary_cleaner.state.floatbank3_b_level  5856 non-null   float64
 43  secondary_cleaner.state.floatbank4_a_air    5856 non-null   float64
 44  secondary_cleaner.state.floatbank4_a_level  5856 non-null   float64
 45  secondary_cleaner.state.floatbank4_b_air    5856 non-null   float64
 46  secondary_cleaner.state.floatbank4_b_level  5856 non-null   float64
 47  secondary_cleaner.state.floatbank5_a_air    5856 non-null   float64
 48  secondary_cleaner.state.floatbank5_a_level  5856 non-null   float64
 49  secondary_cleaner.state.floatbank5_b_air    5856 non-null   float64
 50  secondary_cleaner.state.floatbank5_b_level  5856 non-null   float64
 51  secondary_cleaner.state.floatbank6_a_air    5856 non-null   float64
 52  secondary_cleaner.state.floatbank6_a_level  5856 non-null   float64
dtypes: float64(52), object(1)
memory usage: 2.4+ MB</code></pre>
</div>
</div>
<p>The time series data filling section implements a comprehensive approach to handling missing values in the gold recovery process data. It creates separate copies of the training and test datasets, then distinguishes between numeric and non-numeric columns for appropriate processing.</p>
<p>The core functionality lies in the <code>advanced_fill</code> function, which employs a multi-strategy approach: it first attempts rolling average interpolation with various window sizes (50, 100, and 200 points), selecting the one that minimizes missing values, and then applies forward and backward filling as a fallback method for any remaining gaps. This approach is an attempt to ensure that temporal relationships in the industrial process data are preserved while providing complete datasets for subsequent modeling, making it particularly suitable for continuous manufacturing processes where measurements are closely related in time.</p>
</section>
</section>
</section>
<section id="data-fill-experiment-baseline-vs-ffillbfill-vs-forward-fill" class="level1">
<h1>Data Fill Experiment (baseline vs ffill+bfill vs forward fill)</h1>
<div id="cell-47" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_target_handling_approaches(train_df, filled_train_df, test_df, filled_test_df, </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                                     target_columns<span class="op">=</span>[<span class="st">'rougher.output.recovery'</span>, <span class="st">'final.output.recovery'</span>],</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                                     random_state<span class="op">=</span><span class="dv">12345</span>):</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get feature columns (excluding target columns)</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> train_df.columns <span class="cf">if</span> <span class="bu">any</span>(x <span class="kw">in</span> col <span class="cf">for</span> x <span class="kw">in</span> [ </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'feed'</span>, <span class="st">'particle_size'</span>, <span class="st">'concentration'</span>, <span class="st">'state'</span>, <span class="st">'floatbank'</span>])]</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Approach 1: Baseline - Drop missing targets and features</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    baseline_train <span class="op">=</span> train_df.dropna(subset<span class="op">=</span>target_columns).copy()</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    baseline_train <span class="op">=</span> baseline_train.dropna(subset<span class="op">=</span>feature_cols)  <span class="co"># Also drop rows with missing features</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Baseline approach - Shape after dropping all missing values: </span><span class="sc">{</span>baseline_train<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Approach 2: Use filled values</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    filled_approach <span class="op">=</span> filled_train_df.copy()</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Filled approach - Shape: </span><span class="sc">{</span>filled_approach<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize model</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span>random_state)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dictionary to store results</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate both approaches</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> target <span class="kw">in</span> target_columns:</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Evaluating target: </span><span class="sc">{</span>target<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Baseline approach evaluation</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>        baseline_scores <span class="op">=</span> cross_val_score(</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>            rf_model,</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>            baseline_train[feature_cols],</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>            baseline_train[target],</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>            scoring<span class="op">=</span><span class="st">'neg_mean_absolute_error'</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Filled approach evaluation</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        filled_scores <span class="op">=</span> cross_val_score(</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>            rf_model,</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>            filled_approach[feature_cols],</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>            filled_approach[target],</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>            scoring<span class="op">=</span><span class="st">'neg_mean_absolute_error'</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store results</span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>        results[target] <span class="op">=</span> {</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">'baseline_mae'</span>: <span class="op">-</span>baseline_scores.mean(),</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">'baseline_std'</span>: baseline_scores.std(),</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">'filled_mae'</span>: <span class="op">-</span>filled_scores.mean(),</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">'filled_std'</span>: filled_scores.std()</span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print results</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Results for </span><span class="sc">{</span>target<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Baseline approach - MAE: </span><span class="sc">{</span><span class="op">-</span>baseline_scores<span class="sc">.</span>mean()<span class="sc">:2e}</span><span class="ss"> (+/- </span><span class="sc">{</span>baseline_scores<span class="sc">.</span>std()<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Filled approach   - MAE: </span><span class="sc">{</span><span class="op">-</span>filled_scores<span class="sc">.</span>mean()<span class="sc">:2e}</span><span class="ss"> (+/- </span><span class="sc">{</span>filled_scores<span class="sc">.</span>std()<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print summary of findings</span></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Summary of findings:"</span>)</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Original dataset size: </span><span class="sc">{</span>train_df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> rows"</span>)</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Baseline dataset size: </span><span class="sc">{</span>baseline_train<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> rows"</span>)</span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Rows removed in baseline: </span><span class="sc">{</span>train_df<span class="sc">.</span>shape[<span class="dv">0</span>] <span class="op">-</span> baseline_train<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>((train_df.shape[<span class="dv">0</span>] <span class="op">-</span> baseline_train.shape[<span class="dv">0</span>])<span class="op">/</span>train_df.shape[<span class="dv">0</span>]<span class="op">*</span><span class="dv">100</span>)<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> target, metrics <span class="kw">in</span> results.items():</span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Target: </span><span class="sc">{</span>target<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>        difference <span class="op">=</span> metrics[<span class="st">'filled_mae'</span>] <span class="op">-</span> metrics[<span class="st">'baseline_mae'</span>]</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Performance difference (Filled - Baseline): </span><span class="sc">{</span>difference<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> difference <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"→ Filled approach performed better"</span>)</span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"→ Baseline approach performed better"</span>)</span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">'baseline_train'</span>: baseline_train,</span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">'filled_train'</span>: filled_approach,</span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">'results'</span>: results</span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the comparison</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a>comparison_results <span class="op">=</span> compare_target_handling_approaches(</span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>    train_df<span class="op">=</span>train_df,</span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>    filled_train_df<span class="op">=</span>filled_train_df,</span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>    test_df<span class="op">=</span>test_df,</span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>    filled_test_df<span class="op">=</span>filled_test_df</span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Baseline approach - Shape after dropping all missing values: (12767, 88)
Filled approach - Shape: (16860, 88)

Evaluating target: rougher.output.recovery

Results for rougher.output.recovery:
Baseline approach - MAE: 9.053953e+00 (+/- 1.6705)
Filled approach   - MAE: 8.865629e+00 (+/- 0.7248)

Evaluating target: final.output.recovery

Results for final.output.recovery:
Baseline approach - MAE: 6.467998e+00 (+/- 0.9802)
Filled approach   - MAE: 8.050654e+00 (+/- 1.4435)

Summary of findings:
--------------------------------------------------
Original dataset size: 16860 rows
Baseline dataset size: 12767 rows
Rows removed in baseline: 4093 (24.3%)

Target: rougher.output.recovery
Performance difference (Filled - Baseline): -0.1883
→ Filled approach performed better

Target: final.output.recovery
Performance difference (Filled - Baseline): 1.5827
→ Baseline approach performed better</code></pre>
</div>
</div>
<section id="fill-experiment-including-bfill" class="level3">
<h3 class="anchored" data-anchor-id="fill-experiment-including-bfill">Fill Experiment Including <code>bfill()</code></h3>
<p><strong>For the rougher.output.recovery:</strong></p>
<ul>
<li>The filled approach performed slightly better with an MAE of 8.78 compared to the baseline’s 9.05</li>
<li>Notably, the filled approach also showed more consistent performance with a lower standard deviation (0.76 vs 1.67), suggesting more stable predictions</li>
<li>This indicates that for rougher output recovery, the additional data points and filling strategy are beneficial</li>
</ul>
<p><strong>However, for the final.output.recovery:</strong></p>
<ul>
<li>The baseline approach significantly outperformed the filled approach (MAE 6.47 vs 8.05)</li>
<li>The baseline also showed better stability with a lower standard deviation (0.98 vs 1.44)</li>
<li>This suggests that for final recovery, using only complete cases leads to more accurate predictions</li>
</ul>
</section>
<section id="fill-experiment-excluding-bfill" class="level3">
<h3 class="anchored" data-anchor-id="fill-experiment-excluding-bfill">Fill Experiment Excluding <code>bfill()</code></h3>
</section>
<section id="fill-experiment-forward-fill-method" class="level3">
<h3 class="anchored" data-anchor-id="fill-experiment-forward-fill-method">Fill Experiment (Forward Fill Method)</h3>
<div id="cell-50" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the results with previous approach</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>comparison_results <span class="op">=</span> compare_target_handling_approaches(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    train_df<span class="op">=</span>train_df,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    filled_train_df<span class="op">=</span>ffill_train_df,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    test_df<span class="op">=</span>test_df,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    filled_test_df<span class="op">=</span>ffill_test_df</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Baseline approach - Shape after dropping all missing values: (12767, 88)
Filled approach - Shape: (16860, 88)

Evaluating target: rougher.output.recovery

Results for rougher.output.recovery:
Baseline approach - MAE: 9.053953e+00 (+/- 1.6705)
Filled approach   - MAE: 8.865629e+00 (+/- 0.7248)

Evaluating target: final.output.recovery

Results for final.output.recovery:
Baseline approach - MAE: 6.467998e+00 (+/- 0.9802)
Filled approach   - MAE: 8.050654e+00 (+/- 1.4435)

Summary of findings:
--------------------------------------------------
Original dataset size: 16860 rows
Baseline dataset size: 12767 rows
Rows removed in baseline: 4093 (24.3%)

Target: rougher.output.recovery
Performance difference (Filled - Baseline): -0.1883
→ Filled approach performed better

Target: final.output.recovery
Performance difference (Filled - Baseline): 1.5827
→ Baseline approach performed better</code></pre>
</div>
</div>
<ol type="1">
<li>In the original filling method, <code>bfill()</code> is only used as a fallback after:
<ul>
<li>Trying rolling average interpolation with different window sizes</li>
<li>Applying <code>ffill()</code></li>
</ul></li>
<li>Given the time series nature of the data and the fact that we’re getting identical results, this suggests that:
<ul>
<li>The rolling average interpolation and <code>ffill()</code> were likely handling most of the missing values</li>
<li>By the time the code reached the <code>bfill()</code> step, there were probably no remaining missing values to fill</li>
<li>The temporal structure of the data means most gaps were being filled by forward methods before backward fill was even attempted</li>
</ul></li>
</ol>
<p>Given these results, we can confidently proceed with the initial filling utilizing the <code>advanced_fill</code> option.</p>
</section>
</section>
<section id="analysis" class="level1">
<h1>Analysis</h1>
<section id="metal-concentration" class="level2">
<h2 class="anchored" data-anchor-id="metal-concentration">Metal Concentration</h2>
<div id="cell-54" class="cell" data-scrolled="false" data-execution_count="29">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_metal_concentrations(train_df, test_df):    </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure for metal concentration changes</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">10</span>))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    metals <span class="op">=</span> [<span class="st">'au'</span>, <span class="st">'ag'</span>, <span class="st">'pb'</span>]</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    stages <span class="op">=</span> [<span class="st">'rougher.input.feed'</span>, <span class="st">'rougher.output.concentrate'</span>, <span class="st">'final.output.concentrate'</span>]</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    stage_labels <span class="op">=</span> [<span class="st">'Raw Feed'</span>, <span class="st">'Rougher Concentrate'</span>, <span class="st">'Final Concentrate'</span>]</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, metal <span class="kw">in</span> <span class="bu">enumerate</span>(metals):</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>        means <span class="op">=</span> []</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>        sems <span class="op">=</span> []</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get concentrations for each stage</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> stage_prefix <span class="kw">in</span> stages:</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>            col <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>stage_prefix<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>metal<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> train_df.columns:</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>                mean <span class="op">=</span> train_df[col].mean()</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>                sem <span class="op">=</span> train_df[col].sem()</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>                means.append(mean)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>                sems.append(sem)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot concentrations with improved styling</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> np.arange(<span class="bu">len</span>(stages))</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>        bars <span class="op">=</span> axes[idx].bar(x, means, </span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>                           color<span class="op">=</span><span class="st">'#121314'</span>,</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>                           width<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>                           alpha<span class="op">=</span><span class="fl">0.85</span>)</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Customize each subplot</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>        axes[idx].set_title(<span class="ss">f'</span><span class="sc">{</span>metal<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> Concentration Changes'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>        axes[idx].set_xticks(x)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>        axes[idx].set_xticklabels(stage_labels)</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>        axes[idx].set_ylabel(<span class="st">'Concentration'</span>, labelpad<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove top and right spines</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>        sns.despine(ax<span class="op">=</span>axes[idx]) <span class="co"># making space for pct_change labels</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add percentage changes</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(means)):</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>            pct_change <span class="op">=</span> ((means[i] <span class="op">-</span> means[i<span class="op">-</span><span class="dv">1</span>]) <span class="op">/</span> means[i<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> <span class="st">'#2E7D32'</span> <span class="cf">if</span> pct_change <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'#C62828'</span>  <span class="co"># Green for positive, red for negative</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>            axes[idx].annotate(</span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f'</span><span class="sc">{</span>pct_change<span class="sc">:+.1f}</span><span class="ss">%'</span>,</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>                xy<span class="op">=</span>(i, means[i]),</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>                xytext<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">8</span>),</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>                textcoords<span class="op">=</span><span class="st">'offset points'</span>,</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>                va<span class="op">=</span><span class="st">'bottom'</span>,</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>color,</span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>                fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">10</span></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add value labels on bars</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(means):</span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>            axes[idx].text(i, v<span class="op">/</span><span class="dv">2</span>,  <span class="co"># Position in middle of bar</span></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>                         <span class="ss">f'</span><span class="sc">{</span>v<span class="sc">:.1f}</span><span class="ss">'</span>,</span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>                         ha<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>                         va<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>                         color<span class="op">=</span><span class="st">'white'</span>,</span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>                         fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust layout</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-55" class="cell" data-scrolled="false" data-execution_count="30">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>analyze_metal_concentrations(filled_train_df, filled_test_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The three bar graphs illustrate the concentration changes of gold (AU), silver (AG), and lead (PB) throughout different stages of the purification process. Gold demonstrates the most significant enrichment, starting at 7.1 in the raw feed, increasing by 142.7% to 17.4 in the rougher concentrate, and finally reaching 39.4 in the final concentrate, marking a total increase of 127.0%. Silver shows a different pattern, initially increasing by 35.1% from 7.8 to 10.5 in the rougher concentrate, but then decreasing significantly by 55.4% to 4.7 in the final concentrate. Lead follows a steady upward trend, starting at 3.2 in the raw feed, increasing by 114.3% to 6.9 in the rougher concentrate, and finally reaching 9.1 in the final concentrate, showing a 32.5% increase in the final stage. These patterns reveal that the purification process is most effective for gold concentration while having varying effects on silver and lead, with silver notably being reduced in the final stage.</p>
</section>
<section id="particle-size-distribution" class="level2">
<h2 class="anchored" data-anchor-id="particle-size-distribution">Particle Size Distribution</h2>
<p>The <strong>Kolmogorov-Smirnov (KS)</strong> test was chosen for this analysis because it’s specifically designed to determine whether two samples come from the same distribution, making it ideal for comparing particle size distributions between training and test datasets. The KS test is particularly suitable here because it’s non-parametric (doesn’t assume a normal distribution) and can detect differences in both the shape and location of distributions, which is crucial for particle size analysis in industrial processes.</p>
<div id="cell-59" class="cell" data-scrolled="false" data-execution_count="31">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_particle_size_distribution(train_df, test_df):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Analyze feed particle size distribution</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    feed_size_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> train_df.columns <span class="cf">if</span> <span class="st">'feed_size'</span> <span class="kw">in</span> col]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">6</span>))</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    fig.suptitle(<span class="st">'Feed Particle Size Distribution Comparison'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot distributions</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> feed_size_cols:</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> train_df.columns <span class="kw">and</span> col <span class="kw">in</span> test_df.columns:</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>            sns.kdeplot(data<span class="op">=</span>train_df[col].dropna(), ax<span class="op">=</span>axes[<span class="dv">0</span>], label<span class="op">=</span>col)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>            sns.kdeplot(data<span class="op">=</span>test_df[col].dropna(), ax<span class="op">=</span>axes[<span class="dv">1</span>], label<span class="op">=</span>col)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'Training Set'</span>)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'Test Set'</span>)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Particle Size'</span>)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Particle Size'</span>)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].legend()</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].legend()</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Kolmogorov-Smirnov test for each size distribution</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Kolmogorov-Smirnov Test Results:"</span>)</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> feed_size_cols:</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> train_df.columns <span class="kw">and</span> col <span class="kw">in</span> test_df.columns:</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>            statistic, pvalue <span class="op">=</span> stats.ks_2samp(train_df[col].dropna(), test_df[col].dropna())</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"KS statistic: </span><span class="sc">{</span>statistic<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"p-value: </span><span class="sc">{</span>pvalue<span class="sc">:2e}</span><span class="ss">"</span>)</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>()</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-60" class="cell" data-scrolled="false" data-execution_count="32">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>analyze_particle_size_distribution(filled_train_df, filled_test_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Kolmogorov-Smirnov Test Results:
primary_cleaner.input.feed_size:
KS statistic: 0.0520
p-value: 1.202248e-10

rougher.input.feed_size:
KS statistic: 0.1935
p-value: 5.994895e-143
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-32-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The analysis of particle size distributions between training and test datasets reveals a consistent bimodal pattern across both sets, characterized by a sharp, concentrated peak for primary cleaner input near size <strong>0</strong> (indicating finely ground particles) and a broader, lower distribution for rougher input centered around size <strong>50</strong> (suggesting more varied particle sizes). This visual consistency in distribution patterns between training and test sets suggests overall stability in the grinding and classification processes.</p>
<p>However, the <strong>Kolmogorov-Smirnov</strong> test results indicate statistically significant differences between the training and test distributions, with p-values well below the <strong>0.05</strong> threshold for both measurements. The primary cleaner input shows better alignment between sets with a lower KS statistic of <strong>0.0520</strong>, compared to the rougher input’s higher statistic of <strong>0.1935</strong>. While these differences are statistically significant, the visual similarity of the distributions and relatively small KS statistics suggest that these variations are unlikely to substantially impact the model’s predictive performance, though they should be considered during model evaluation and interpretation.</p>
</section>
<section id="total-concentrations" class="level2">
<h2 class="anchored" data-anchor-id="total-concentrations">Total Concentrations</h2>
<div id="cell-63" class="cell" data-scrolled="false" data-execution_count="33">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_total_concentrations(train_df, test_df):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define stages and metals to analyze</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    stages <span class="op">=</span> [<span class="st">'rougher.input.feed'</span>, <span class="st">'rougher.output.concentrate'</span>, <span class="st">'final.output.concentrate'</span>]</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    metals <span class="op">=</span> [<span class="st">'au'</span>, <span class="st">'ag'</span>, <span class="st">'pb'</span>]</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(stages), figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    fig.suptitle(<span class="st">'Total Concentration Distributions by Stage (Excluding Outliers)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    outliers_info <span class="op">=</span> {}</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    all_concentrations <span class="op">=</span> []</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, stage <span class="kw">in</span> <span class="bu">enumerate</span>(stages):</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>        total_concentration <span class="op">=</span> pd.Series(<span class="dv">0</span>, index<span class="op">=</span>train_df.index)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sum up concentrations of all metals at this stage</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> metal <span class="kw">in</span> metals:</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>            col <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>metal<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> train_df.columns:</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>                total_concentration <span class="op">+=</span> train_df[col].fillna(<span class="dv">0</span>)</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate outlier boundaries</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>        Q1 <span class="op">=</span> total_concentration.quantile(<span class="fl">0.25</span>)</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>        Q3 <span class="op">=</span> total_concentration.quantile(<span class="fl">0.75</span>)</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>        IQR <span class="op">=</span> Q3 <span class="op">-</span> Q1</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>        lower_bound <span class="op">=</span> Q1 <span class="op">-</span> <span class="fl">1.5</span> <span class="op">*</span> IQR</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>        upper_bound <span class="op">=</span> Q3 <span class="op">+</span> <span class="fl">1.5</span> <span class="op">*</span> IQR</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Filter out outliers</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>        clean_concentration <span class="op">=</span> total_concentration[</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>            (total_concentration <span class="op">&gt;=</span> lower_bound) <span class="op">&amp;</span> </span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>            (total_concentration <span class="op">&lt;=</span> upper_bound)</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>        all_concentrations.append(clean_concentration)</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store outlier information</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>        outliers <span class="op">=</span> total_concentration[(total_concentration <span class="op">&lt;</span> lower_bound) <span class="op">|</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>                                     (total_concentration <span class="op">&gt;</span> upper_bound)]</span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>        outliers_info[stage] <span class="op">=</span> {</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'count'</span>: <span class="bu">len</span>(outliers),</span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">'percentage'</span>: (<span class="bu">len</span>(outliers) <span class="op">/</span> <span class="bu">len</span>(total_concentration)) <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bounds'</span>: (lower_bound, upper_bound),</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Q1'</span>: Q1,</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Q3'</span>: Q3</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot boxplot without outliers</span></span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>        sns.boxplot(y<span class="op">=</span>clean_concentration, ax<span class="op">=</span>axes[idx], showfliers<span class="op">=</span><span class="va">False</span>, color<span class="op">=</span><span class="st">'#3498db'</span>)</span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a>        axes[idx].set_title(<span class="ss">f'</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ch">\n</span><span class="ss">Showing </span><span class="sc">{</span><span class="bu">len</span>(clean_concentration)<span class="sc">}</span><span class="ss"> non-outlier points</span><span class="ch">\n</span><span class="ss">'</span></span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f'(Excluded </span><span class="sc">{</span><span class="bu">len</span>(outliers)<span class="sc">}</span><span class="ss"> outliers, </span><span class="sc">{</span>outliers_info[stage][<span class="st">"percentage"</span>]<span class="sc">:.1f}</span><span class="ss">%)'</span>)</span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>        axes[idx].set_ylabel(<span class="st">'Total Concentration'</span>)</span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add a text box with summary statistics</span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a>        stats_text <span class="op">=</span> <span class="ss">f'Median: </span><span class="sc">{</span>clean_concentration<span class="sc">.</span>median()<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">'</span></span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a>        stats_text <span class="op">+=</span> <span class="ss">f'Q1-Q3: [</span><span class="sc">{</span>Q1<span class="sc">:.2f}</span><span class="ss">-</span><span class="sc">{</span>Q3<span class="sc">:.2f}</span><span class="ss">]</span><span class="ch">\n</span><span class="ss">'</span></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a>        stats_text <span class="op">+=</span> <span class="ss">f'Min: </span><span class="sc">{</span>clean_concentration<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">'</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a>        stats_text <span class="op">+=</span> <span class="ss">f'Max: </span><span class="sc">{</span>clean_concentration<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">'</span></span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>        stats_text <span class="op">+=</span> <span class="ss">f'Mean: </span><span class="sc">{</span>clean_concentration<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">'</span></span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>        axes[idx].text(<span class="fl">0.27</span>, <span class="op">-</span><span class="fl">0.2</span>, stats_text,</span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>                      transform<span class="op">=</span>axes[idx].transAxes,</span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>                      bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>),</span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>                      verticalalignment<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-64" class="cell" data-scrolled="false" data-execution_count="34">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>analyze_total_concentrations(filled_train_df, filled_test_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-34-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Analysis of the concentration distributions across the three processing stages reveals a clear and effective purification progression. The total concentration systematically increases from an average of around 20 in the rougher input feed, to 40 in the rougher output concentrate, and finally reaching approximately 60 in the final output concentrate. This doubling of concentration at each stage demonstrates the effectiveness of the purification process. Furthermore, the data shows increasing stability in the later stages, with the final output concentrate displaying the narrowest interquartile range, suggesting a more controlled and consistent end product.</p>
<p>It’s worth noting that each stage required the removal of 10-15% of data points as outliers, with similar proportions across all stages (10.1%, 15.1%, and 14.6% respectively). The symmetrical nature of the distributions, evidenced by the close alignment of mean and median values at each stage, along with the consistent removal of outliers, suggests a well-controlled process despite some variability in the input materials. This stability is particularly important for maintaining reliable production quality and predictable recovery rates.</p>
</section>
</section>
<section id="preprocessing-and-other-helper-functions" class="level1">
<h1>Preprocessing and Other Helper Functions</h1>
<section id="feature-preparation" class="level2">
<h2 class="anchored" data-anchor-id="feature-preparation">Feature Preparation</h2>
<p>This feature preparation function handles the preprocessing of data for the gold recovery prediction model. It performs three main tasks: <strong>feature selection</strong>, <strong>alignment</strong>, and <strong>standardization</strong>. The function first selects relevant features related to feed characteristics: <em>particle size</em>, <em>concentration</em>, <em>state</em>, and <em>floatbank</em> parameters while excluding target variables (recovery rates). <strong>When a test dataset is provided, it ensures feature consistency by keeping only columns present in both training and test sets.</strong></p>
<p>Finally, it standardizes the numerical features using <code>StandardScaler</code> to normalize the data scale. The function is flexible, returning either the processed training data alone or both training and test data along with feature names and the fitted scaler for later use in predictions.</p>
<div id="cell-69" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_features(train_df, test_df<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select relevant numerical features from training data</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    feature_columns <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> train_df.columns <span class="cf">if</span> <span class="bu">any</span>(x <span class="kw">in</span> col <span class="cf">for</span> x <span class="kw">in</span> [ </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'feed'</span>, <span class="st">'particle_size'</span>, <span class="st">'concentration'</span>, <span class="st">'state'</span>, <span class="st">'floatbank'</span>])]</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove target columns</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    target_columns <span class="op">=</span> [<span class="st">'rougher.output.recovery'</span>, <span class="st">'final.output.recovery'</span>]</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    feature_columns <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> feature_columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> target_columns]</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only keep features present in both datasets</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> test_df <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        feature_columns <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> feature_columns <span class="cf">if</span> col <span class="kw">in</span> test_df.columns]</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Number of aligned features: </span><span class="sc">{</span><span class="bu">len</span>(feature_columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> train_df[feature_columns]</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale features</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    X_train_scaled <span class="op">=</span> scaler.fit_transform(X_train)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> test_df <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>        X_test <span class="op">=</span> test_df[feature_columns]</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>        X_test_scaled <span class="op">=</span> scaler.transform(X_test)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X_train_scaled, X_test_scaled, feature_columns, scaler</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X_train_scaled, feature_columns, scaler</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="smape-calculator" class="level2">
<h2 class="anchored" data-anchor-id="smape-calculator">sMAPE Calculator</h2>
<p><span class="math display">\[ sMAPE = \frac{1}{N} \sum_{i=1}^{N} \frac{|y_i - \hat{y_i}|}{(|y_i| + |\hat{y_i}|)/2} \times 100\% \]</span></p>
<p>The Symmetric Mean Absolute Percentage Error (sMAPE) is implemented here as a robust metric for evaluating the gold recovery prediction model’s performance. This implementation includes special handling for edge cases, particularly when dealing with zero values which are common in industrial process data. The function calculates the percentage error by taking the absolute difference between predicted and actual values (numerator) and dividing it by the average of their absolute values (denominator), then multiplying by 100 to express it as a percentage.</p>
<p>The symmetrical nature of sMAPE makes it particularly suitable for our gold recovery predictions because it treats over-predictions and under-predictions equally, which is crucial when optimizing recovery processes where both types of errors can be costly. The function includes safeguards against division by zero and handles invalid cases gracefully, returning 0 when no valid calculations can be made. This is especially important in industrial applications where we need reliable error measurements to make operational decisions about the recovery process.</p>
<div id="cell-72" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_smape(y_true, y_pred):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert inputs to numpy arrays</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.array(y_true)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.array(y_pred)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle cases where both true and predicted values are 0</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    denominator <span class="op">=</span> (np.<span class="bu">abs</span>(y_true) <span class="op">+</span> np.<span class="bu">abs</span>(y_pred)) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a mask for valid entries (non-zero denominator)</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    valid_mask <span class="op">=</span> denominator <span class="op">!=</span> <span class="dv">0</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> np.<span class="bu">any</span>(valid_mask):</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span>  <span class="co"># Return 0 if all denominators are 0</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate sMAPE only for valid entries</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    numerator <span class="op">=</span> np.<span class="bu">abs</span>(y_true <span class="op">-</span> y_pred)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    smape <span class="op">=</span> np.mean(np.divide(numerator[valid_mask], denominator[valid_mask])) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> smape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="final-smape-calculator" class="level2">
<h2 class="anchored" data-anchor-id="final-smape-calculator">Final sMAPE Calculator</h2>
<p><span class="math display">\[ \text{Final sMAPE} = 25\% \times \text{sMAPE(rougher)} + 75\% \times \text{sMAPE(final)} \]</span></p>
<p>This function implements a weighted evaluation metric specifically designed for the gold recovery process, combining error measurements from both the rougher and final recovery stages. The function calculates individual sMAPE values for each stage and then applies a weighted average where the rougher stage contributes 25% and the final stage contributes 75% to the overall score. This weighting reflects the greater importance of accuracy in the final recovery stage, which directly impacts the end product quality.</p>
<p>The function also provides detailed diagnostic information, displaying the range of true and predicted values for both stages along with their individual sMAPE scores, which helps in understanding where prediction errors are occurring and their relative magnitudes. This comprehensive error assessment is crucial for evaluating and optimizing the model’s performance across the entire recovery process.</p>
<div id="cell-75" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_final_smape(y_true_rougher, y_pred_rougher, y_true_final, y_pred_final):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    rougher_smape <span class="op">=</span> calculate_smape(y_true_rougher, y_pred_rougher)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    final_smape <span class="op">=</span> calculate_smape(y_true_final, y_pred_final)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print sNAPE information</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Rougher sMAPE components:"</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Range of true values: [</span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(y_true_rougher)<span class="sc">:.2f}</span><span class="ss">, </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(y_true_rougher)<span class="sc">:.2f}</span><span class="ss">]"</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Range of predicted values: [</span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(y_pred_rougher)<span class="sc">:.2f}</span><span class="ss">, </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(y_pred_rougher)<span class="sc">:.2f}</span><span class="ss">]"</span>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Calculated rougher sMAPE: </span><span class="sc">{</span>rougher_smape<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final sMAPE components:"</span>)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Range of true values: [</span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(y_true_final)<span class="sc">:.2f}</span><span class="ss">, </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(y_true_final)<span class="sc">:.2f}</span><span class="ss">]"</span>)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Range of predicted values: [</span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(y_pred_final)<span class="sc">:.2f}</span><span class="ss">, </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(y_pred_final)<span class="sc">:.2f}</span><span class="ss">]"</span>)</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Calculated final sMAPE: </span><span class="sc">{</span>final_smape<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.25</span> <span class="op">*</span> rougher_smape <span class="op">+</span> <span class="fl">0.75</span> <span class="op">*</span> final_smape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation">Model Evaluation</h2>
<section id="model-evaluation-function" class="level3">
<h3 class="anchored" data-anchor-id="model-evaluation-function">Model Evaluation Function</h3>
<p>Handling comprehensive model evaluation, calculating both Mean Absolute Error (MAE) and sMAPE metrics for training and test sets. It makes predictions on both datasets, computes the evaluation metrics, and optionally prints detailed results. The function returns a dictionary containing all computed metrics for further analysis.</p>
<div id="cell-78" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model Evaluation Functions</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_model(model, X_train, X_test, y_train, y_test, model_name<span class="op">=</span><span class="st">""</span>, verbose<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make predictions</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    train_pred <span class="op">=</span> model.predict(X_train)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    test_pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate metrics</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    train_mae <span class="op">=</span> mean_absolute_error(y_train, train_pred)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    test_mae <span class="op">=</span> mean_absolute_error(y_test, test_pred)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    train_smape <span class="op">=</span> calculate_smape(y_train, train_pred)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    test_smape <span class="op">=</span> calculate_smape(y_test, test_pred)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> Evaluation Results:"</span>)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Training MAE: </span><span class="sc">{</span>train_mae<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Test MAE: </span><span class="sc">{</span>test_mae<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Training sMAPE: </span><span class="sc">{</span>train_smape<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Test sMAPE: </span><span class="sc">{</span>test_smape<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train_mae'</span>: train_mae,</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_mae'</span>: test_mae,</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train_smape'</span>: train_smape,</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_smape'</span>: test_smape</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cross-validation-implimentation" class="level3">
<h3 class="anchored" data-anchor-id="cross-validation-implimentation">Cross Validation Implimentation</h3>
<p>Implements k-fold cross-validation (default 5 folds) to assess model stability. It uses negative MAE as the scoring metric, which is converted to positive values for easier interpretation. The function returns both the mean and standard deviation of cross-validation scores, providing insight into model consistency across different data subsets.</p>
<div id="cell-80" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> perform_cross_validation(model, X, y, cv<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> cross_val_score(model, X, y, cv<span class="op">=</span>cv, scoring<span class="op">=</span><span class="st">'neg_mean_absolute_error'</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> <span class="op">-</span>cv_scores  <span class="co"># Convert negative MAE to positive</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cv_scores.mean(), cv_scores.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-forest-optimization" class="level3">
<h3 class="anchored" data-anchor-id="random-forest-optimization">Random Forest Optimization</h3>
<p>Implements an automated hyperparameter optimization process for the Random Forest model specifically tailored to the gold recovery prediction task. The function uses GridSearchCV to systematically explore different combinations of key Random Forest parameters. It explores four key hyperparameters: number of trees (30-200), maximum tree depth (10-30), minimum samples for splitting nodes (5), and minimum samples per leaf (2). The optimization process uses 3-fold cross-validation with negative mean absolute error as the scoring metric, and leverages parallel processing (n_jobs=-1) for efficiency. The function returns both the best performing model configuration and its associated parameters, providing a balanced approach between model complexity and performance for the industrial process prediction task.</p>
<div id="cell-82" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tune_random_forest_optimized(X_train, X_test, y_train, y_test):</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    param_grid <span class="op">=</span> {</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_estimators'</span>: [<span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>],</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'max_depth'</span>: [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>],</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'min_samples_split'</span>: [<span class="dv">5</span>],</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'min_samples_leaf'</span>: [<span class="dv">2</span>]</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    base_rf <span class="op">=</span> RandomForestRegressor(random_state<span class="op">=</span><span class="dv">42</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    grid_search <span class="op">=</span> GridSearchCV(</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>        base_rf,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>        param_grid,</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>        cv<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>        scoring<span class="op">=</span><span class="st">'neg_mean_absolute_error'</span>,</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    grid_search.fit(X_train, y_train)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> grid_search.best_estimator_, grid_search.best_params_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="modeling-helper-function" class="level3">
<h3 class="anchored" data-anchor-id="modeling-helper-function">Modeling Helper Function</h3>
<p>Orchestrates the entire modeling process by:</p>
<ul>
<li>Training a baseline Linear Regression model</li>
<li>Building a basic Random Forest with reduced estimators (50) for initial assessment</li>
<li>Creating an optimized Random Forest using hyperparameter tuning via GridSearchCV (with parameters like n_estimators, max_depth, min_samples_split, and min_samples_leaf)</li>
</ul>
<p>Each model is evaluated consistently using the same metrics, and results are stored in a dictionary for comparison. The tuned Random Forest represents the most sophisticated approach, incorporating optimal hyperparameters found through grid search.</p>
<div id="cell-84" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_and_evaluate_models_optimized(X_train, X_test, y_train, y_test):</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    models <span class="op">=</span> {}</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear Regression</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Training Linear Regression..."</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    lr_model <span class="op">=</span> LinearRegression()</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    lr_model.fit(X_train, y_train)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    lr_metrics <span class="op">=</span> evaluate_model(lr_model, X_train, X_test, y_train, y_test, <span class="st">"Linear Regression"</span>)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">'linear_regression'</span>] <span class="op">=</span> {<span class="st">'model'</span>: lr_model, <span class="st">'metrics'</span>: lr_metrics}</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic Random Forest with reduced estimators</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Training Basic Random Forest..."</span>)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span><span class="dv">12345</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    rf_model.fit(X_train, y_train)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    rf_metrics <span class="op">=</span> evaluate_model(rf_model, X_train, X_test, y_train, y_test, <span class="st">"Basic Random Forest"</span>)</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">'basic_rf'</span>] <span class="op">=</span> {<span class="st">'model'</span>: rf_model, <span class="st">'metrics'</span>: rf_metrics}</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tuned Random Forest</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Training Tuned Random Forest..."</span>)</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    best_rf, best_params <span class="op">=</span> tune_random_forest_optimized(X_train, X_test, y_train, y_test)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>    tuned_rf_metrics <span class="op">=</span> evaluate_model(best_rf, X_train, X_test, y_train, y_test, <span class="st">"Tuned Random Forest"</span>)</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">'tuned_rf'</span>] <span class="op">=</span> {</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'model'</span>: best_rf,</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'metrics'</span>: tuned_rf_metrics,</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'best_params'</span>: best_params</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> models</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="modeling-procedure" class="level1">
<h1>Modeling Procedure</h1>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data Preparation</h2>
<p>The data preparation phase for the gold recovery prediction model involves a comprehensive preprocessing approach that successfully aligns 49 features between the training and test datasets. The process begins with feature scaling and preparation through the <code>prepare_features</code> function, which ensures consistent feature representation across datasets. Two key target variables are extracted from the filled training data: the rougher stage recovery rate and the final stage recovery rate.</p>
<p>The data is then partitioned using an 80-20 train-validation split with a fixed random state. This split is applied consistently to both target variables, maintaining the integrity of the temporal relationships in the process data.</p>
<div id="cell-87" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare features and targets</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>X_train_scaled, X_test_scaled, feature_columns, scaler <span class="op">=</span> prepare_features(</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    filled_train_df, filled_test_df)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare targets</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>y_train_rougher <span class="op">=</span> filled_train_df[<span class="st">'rougher.output.recovery'</span>]</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>y_train_final <span class="op">=</span> filled_train_df[<span class="st">'final.output.recovery'</span>]</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>X_train, X_val, y_train_rougher, y_val_rougher <span class="op">=</span> train_test_split(</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    X_train_scaled, y_train_rougher, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">12345</span>)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>_, _, y_train_final, y_val_final <span class="op">=</span> train_test_split(</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    X_train_scaled, y_train_final, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">12345</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of aligned features: 49</code></pre>
</div>
</div>
<div id="cell-88" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample the data, reduce training time.</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>sample_size <span class="op">=</span> <span class="dv">6000</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>sample_indices <span class="op">=</span> np.random.choice(<span class="bu">len</span>(X_train), sample_size, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>X_train_sample <span class="op">=</span> X_train[sample_indices]</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>y_train_rougher_sample <span class="op">=</span> y_train_rougher.iloc[sample_indices]</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>y_train_final_sample <span class="op">=</span> y_train_final.iloc[sample_indices]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The above code creates a more manageable subset while maintaining the statistical properties of the original data. This approach significantly reduces computational time during the initial model development and tuning phases without substantially compromising the model’s learning capacity.</p>
<p>The sampling is applied consistently across both feature matrix (X_train) and target variables (rougher and final recovery rates), preserving the relationships between inputs and outputs. This balanced sampling approach allows for faster iteration during model development while still capturing the essential patterns in the gold recovery process data.</p>
<div id="cell-90" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train models</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Training models for rougher recovery:"</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>rougher_models <span class="op">=</span> build_and_evaluate_models_optimized(</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    X_train_sample, X_val, </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    y_train_rougher_sample, y_val_rougher</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Training models for final recovery:"</span>)</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>final_models <span class="op">=</span> build_and_evaluate_models_optimized(</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    X_train_sample, X_val, </span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    y_train_final_sample, y_val_final</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Training models for rougher recovery:
Training Linear Regression...

Linear Regression Evaluation Results:
----------------------------------------
Training MAE: 6.8421
Test MAE: 6.9611
Training sMAPE: 10.5918
Test sMAPE: 10.6660
Training Basic Random Forest...

Basic Random Forest Evaluation Results:
----------------------------------------
Training MAE: 1.7134
Test MAE: 4.2492
Training sMAPE: 5.4860
Test sMAPE: 8.1685
Training Tuned Random Forest...

Tuned Random Forest Evaluation Results:
----------------------------------------
Training MAE: 2.0006
Test MAE: 4.1228
Training sMAPE: 5.8330
Test sMAPE: 7.9791

Training models for final recovery:
Training Linear Regression...

Linear Regression Evaluation Results:
----------------------------------------
Training MAE: 6.4453
Test MAE: 6.6985
Training sMAPE: 10.7009
Test sMAPE: 10.9889
Training Basic Random Forest...

Basic Random Forest Evaluation Results:
----------------------------------------
Training MAE: 1.7309
Test MAE: 4.7238
Training sMAPE: 3.9751
Test sMAPE: 8.1635
Training Tuned Random Forest...

Tuned Random Forest Evaluation Results:
----------------------------------------
Training MAE: 1.9241
Test MAE: 4.6137
Training sMAPE: 4.1946
Test sMAPE: 7.9889</code></pre>
</div>
</div>
<p>For the rougher recovery stage, Linear Regression showed consistent but modest performance with training/test MAE around 6.7-6.9 and sMAPE around 10.4-10.6%. Both Random Forest models significantly improved upon this, with the tuned version achieving slightly better test metrics (MAE: 4.25, sMAPE: 8.04%) compared to the basic version. Similar patterns emerged in the final recovery predictions, where Linear Regression again showed higher errors (MAE: 6.3-6.7, sMAPE: 10.3-10.9%), while both Random Forest variants demonstrated better performance, with the tuned model achieving marginally better test metrics (MAE: 4.64, sMAPE: 8.05%). The gap between training and test performance in the Random Forest models suggests some overfitting, though the tuned version shows slightly better generalization, particularly in the final recovery predictions.</p>
<div id="cell-92" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate final scores</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Calculating final sMAPE scores..."</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_type <span class="kw">in</span> rougher_models.keys():</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    rougher_pred <span class="op">=</span> rougher_models[model_type][<span class="st">'model'</span>].predict(X_val)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    final_pred <span class="op">=</span> final_models[model_type][<span class="st">'model'</span>].predict(X_val)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    final_score <span class="op">=</span> calculate_final_smape(</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        y_val_rougher, rougher_pred,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        y_val_final, final_pred</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>model_type<span class="sc">}</span><span class="ss"> Final sMAPE: </span><span class="sc">{</span>final_score<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Calculating final sMAPE scores...
Rougher sMAPE components:
  Range of true values: [0.00, 100.00]
  Range of predicted values: [51.24, 125.88]
  Calculated rougher sMAPE: 10.67

Final sMAPE components:
  Range of true values: [0.00, 100.00]
  Range of predicted values: [35.38, 107.49]
  Calculated final sMAPE: 10.99

linear_regression Final sMAPE: 10.9082
Rougher sMAPE components:
  Range of true values: [0.00, 100.00]
  Range of predicted values: [1.71, 96.92]
  Calculated rougher sMAPE: 8.17

Final sMAPE components:
  Range of true values: [0.00, 100.00]
  Range of predicted values: [19.68, 100.00]
  Calculated final sMAPE: 8.16

basic_rf Final sMAPE: 8.1647
Rougher sMAPE components:
  Range of true values: [0.00, 100.00]
  Range of predicted values: [2.90, 96.05]
  Calculated rougher sMAPE: 7.98

Final sMAPE components:
  Range of true values: [0.00, 100.00]
  Range of predicted values: [21.32, 100.00]
  Calculated final sMAPE: 7.99

tuned_rf Final sMAPE: 7.9865</code></pre>
</div>
</div>
<p>The Linear Regression model showed the highest combined sMAPE of 10.89%, with prediction ranges exceeding the true value bounds, indicating potential overestimation issues. The Basic Random Forest improved significantly with a combined sMAPE of 8.23%, while the Tuned Random Forest achieved the best performance with a combined sMAPE of 8.05%. The prediction ranges for both Random Forest models stayed closer to the actual value range of 0-100%, suggesting better calibrated predictions. The tuned model’s marginally better performance and more conservative prediction ranges make it the most suitable choice for the gold recovery prediction task, balancing accuracy with prediction reliability.</p>
<div id="cell-94" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_feature_importance(model, feature_names, X_train_shape, title<span class="op">=</span><span class="st">"Feature Importance"</span>):</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(model, <span class="st">'feature_importances_'</span>):</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>        importance <span class="op">=</span> model.feature_importances_</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>        indices <span class="op">=</span> np.argsort(importance)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>        plt.title(title)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        plt.bar(<span class="bu">range</span>(X_train_shape[<span class="dv">1</span>]), importance[indices])</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>        plt.xticks(<span class="bu">range</span>(X_train_shape[<span class="dv">1</span>]), </span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>                  [feature_names[i] <span class="cf">for</span> i <span class="kw">in</span> indices], </span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>                  rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print top 10 most important features</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 10 most important features for </span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">min</span>(<span class="dv">10</span>, <span class="bu">len</span>(feature_names))):</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>feature_names[indices[i]]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>importance[indices[i]]<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-95" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot feature importance for both models</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Plotting feature importance for best models..."</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>plot_feature_importance(</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    rougher_models[<span class="st">'tuned_rf'</span>][<span class="st">'model'</span>],</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    feature_columns,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    X_train_sample.shape,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Feature Importance - Rougher Recovery"</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>plot_feature_importance(</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    final_models[<span class="st">'tuned_rf'</span>][<span class="st">'model'</span>],</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    feature_columns,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    X_train_sample.shape,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Feature Importance - Final Recovery"</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Plotting feature importance for best models...</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-47-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Top 10 most important features for Feature Importance - Rougher Recovery:
rougher.input.floatbank11_sulfate: 0.1007
secondary_cleaner.state.floatbank4_a_air: 0.0894
primary_cleaner.state.floatbank8_b_air: 0.0881
rougher.input.feed_ag: 0.0453
rougher.input.floatbank11_xanthate: 0.0436
rougher.state.floatbank10_d_air: 0.0339
rougher.input.feed_size: 0.0305
rougher.state.floatbank10_a_air: 0.0295
rougher.input.feed_au: 0.0287
secondary_cleaner.state.floatbank6_a_air: 0.0260</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OptimizingGoldRecovery_files/figure-html/cell-47-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Top 10 most important features for Feature Importance - Final Recovery:
rougher.input.floatbank11_xanthate: 0.1069
rougher.input.feed_ag: 0.0829
secondary_cleaner.state.floatbank3_b_level: 0.0571
rougher.input.feed_au: 0.0387
primary_cleaner.input.feed_size: 0.0294
rougher.input.floatbank10_xanthate: 0.0276
secondary_cleaner.state.floatbank4_a_air: 0.0274
rougher.input.feed_size: 0.0270
rougher.input.feed_sol: 0.0260
rougher.input.feed_pb: 0.0254</code></pre>
</div>
</div>
<div id="cell-96" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print final summary</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Best parameters for Rougher Recovery Random Forest:"</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rougher_models[<span class="st">'tuned_rf'</span>][<span class="st">'best_params'</span>])</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Best parameters for Final Recovery Random Forest:"</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(final_models[<span class="st">'tuned_rf'</span>][<span class="st">'best_params'</span>])</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Final Metrics Summary:"</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Rougher Recovery:"</span>)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_type, model_info <span class="kw">in</span> rougher_models.items():</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>model_type<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> metric_name, metric_value <span class="kw">in</span> model_info[<span class="st">'metrics'</span>].items():</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>metric_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>metric_value<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Final Recovery:"</span>)</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_type, model_info <span class="kw">in</span> final_models.items():</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>model_type<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> metric_name, metric_value <span class="kw">in</span> model_info[<span class="st">'metrics'</span>].items():</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>metric_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>metric_value<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Best parameters for Rougher Recovery Random Forest:
{'max_depth': 30, 'min_samples_leaf': 2, 'min_samples_split': 5, 'n_estimators': 200}

Best parameters for Final Recovery Random Forest:
{'max_depth': 30, 'min_samples_leaf': 2, 'min_samples_split': 5, 'n_estimators': 200}

Final Metrics Summary:

Rougher Recovery:
----------------------------------------

linear_regression:
train_mae: 6.8421
test_mae: 6.9611
train_smape: 10.5918
test_smape: 10.6660

basic_rf:
train_mae: 1.7134
test_mae: 4.2492
train_smape: 5.4860
test_smape: 8.1685

tuned_rf:
train_mae: 2.0006
test_mae: 4.1228
train_smape: 5.8330
test_smape: 7.9791

Final Recovery:
----------------------------------------

linear_regression:
train_mae: 6.4453
test_mae: 6.6985
train_smape: 10.7009
test_smape: 10.9889

basic_rf:
train_mae: 1.7309
test_mae: 4.7238
train_smape: 3.9751
test_smape: 8.1635

tuned_rf:
train_mae: 1.9241
test_mae: 4.6137
train_smape: 4.1946
test_smape: 7.9889</code></pre>
</div>
</div>
<p>The final results summary reveals the optimal configurations and comparative performance metrics across all models. The tuned Random Forest models for both rougher and final recovery converged on identical optimal parameters: 200 trees, maximum depth of 30, minimum samples per leaf of 2, and minimum samples for split of 5. This consistency in hyperparameters suggests similar complexity requirements for both prediction tasks.</p>
<p>Linear Regression showed consistent but higher error rates (MAE ~6.3-6.9, sMAPE ~10.3-11.0%) across both recovery stages. Both Random Forest variants demonstrated superior performance, with the tuned version slightly outperforming the basic version in test metrics. The tuned model achieved test MAE of 4.25 and sMAPE of 8.04% for rougher recovery, and test MAE of 4.65 and sMAPE of 8.05% for final recovery. While there is some evidence of overfitting in both Random Forest models (notably lower training errors), the tuned version maintains slightly better generalization performance, making it the most suitable choice for deployment in the gold recovery prediction system.</p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Based on the analysis and modeling of the gold recovery process data, we can draw several key conclusions about the optimal approach to predicting recovery efficiency. The tuned Random Forest model emerged as the superior solution, achieving the best overall performance with a combined weighted sMAPE of 8.05%, significantly outperforming both the baseline Linear Regression (10.90%) and the basic Random Forest (8.23%). The model successfully captures the complexity of both rougher and final recovery stages, with consistent hyperparameters (200 trees, depth of 30) suggesting similar underlying patterns in both processes.</p>
<p>The model evaluation revealed important insights about the process itself: the concentration patterns showed expected enrichment of gold through the stages, particle size distributions remained consistent between training and test sets despite statistical differences, and the careful handling of missing values through rolling average interpolation preserved the temporal characteristics of the data. While there is still room for improvement, particularly in addressing the gap between training and test performance, the current model provides a reliable foundation for predicting gold recovery rates. The implementation of this model could significantly enhance process optimization and decision-making in the gold recovery operation, potentially leading to improved efficiency and reduced operational costs.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>